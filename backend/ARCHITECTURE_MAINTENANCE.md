# 架构文档维护指南

> **AI助手必读**: 每次进行架构相关的代码修改时，必须检查并更新相关的架构文档。

## 维护原则

### 1. 同步更新原则
- **代码先行**: 先完成代码修改，再更新文档
- **即时更新**: 代码修改完成后立即更新相关文档
- **完整性**: 确保文档反映最新的架构状态

### 2. 文档一致性原则
- **准确性**: 文档内容必须与实际代码实现一致
- **完整性**: 重要的架构变更都应在文档中体现
- **时效性**: 文档更新时间不应滞后代码修改超过一个工作会话

## 需要更新文档的场景

### 1. 服务层变更
- 新增/删除/重命名服务类
- 修改服务类的核心方法
- 变更服务间的依赖关系
- 修改数据处理流程

### 2. API变更
- 新增/删除/修改API端点
- 变更API参数或响应格式
- 修改API的业务逻辑
- 变更错误处理机制

### 3. 数据模型变更
- 修改数据库schema
- 变更数据存储模式
- 新增/删除数据字段
- 修改数据验证规则

### 4. 配置变更
- 新增/修改环境变量
- 变更系统配置项
- 修改部署配置
- 变更安全配置

## 文档更新检查清单

### 更新前检查
- [ ] 确认代码修改已完成并测试通过
- [ ] 识别受影响的架构组件
- [ ] 确定需要更新的文档章节

### 更新内容检查
- [ ] 更新架构图和流程图
- [ ] 修改相关的方法签名和描述
- [ ] 更新数据流和处理逻辑
- [ ] 修改配置和部署信息
- [ ] 更新已知问题和改进计划

### 更新后验证
- [ ] 检查文档内容的准确性
- [ ] 验证文档的完整性
- [ ] 确认版本信息已更新
- [ ] 记录更新日志

## 文档结构对应关系

### ARCHITECTURE.md 章节映射

| 代码位置 | 对应文档章节 | 更新触发条件 |
|---------|-------------|-------------|
| `src/services/` | 1. 服务层架构 | 服务类变更 |
| `src/routes/` | 2. API路由层 | API端点变更 |
| `src/models/` | 3. 数据存储层 | 数据模型变更 |
| `src/services/tests/` | 4. 测试架构 | 测试结构变更 |
| `.env`, `config/` | 配置管理 | 配置项变更 |
| `package.json` | 技术栈 | 依赖变更 |

### 特殊关注点

#### DataService 相关更新
- 方法签名变更 → 更新"核心方法"列表
- 新增方法 → 添加到方法列表并描述功能
- 删除方法 → 从文档中移除相关描述
- 修改业务逻辑 → 更新"设计特点"

#### API 相关更新
- 新增端点 → 添加到API端点列表
- 修改响应格式 → 更新数据流架构
- 变更业务逻辑 → 更新请求处理流程

## 版本管理

### 版本号规则
- **主版本号**: 重大架构重构 (如: v1.0 → v2.0)
- **次版本号**: 新增重要功能或服务 (如: v2.0 → v2.1)
- **修订版本号**: 小的修改和优化 (如: v2.1.0 → v2.1.1)

### 更新记录格式
```markdown
**文档更新记录**:
- YYYY-MM-DD: [版本号] 具体更新内容描述
- 2025-01-26: v2.0.0 创建初始架构文档，记录重构后的服务层架构
```

## AI助手操作指南

### 每次会话开始时
1. 检查 `ARCHITECTURE.md` 的最后更新时间
2. 如果距离上次更新超过1天，快速浏览文档确认准确性
3. 如发现不一致，优先更新文档

### 进行架构修改时
1. **修改前**: 记录当前架构状态
2. **修改中**: 注意记录变更的具体内容
3. **修改后**: 立即更新相关文档章节

### 修改完成后
1. 更新文档版本号和更新时间
2. 在更新记录中添加变更说明
3. 检查文档的整体一致性

## 常见更新模板

### 新增服务类
```markdown
#### X.X ServiceName (新增服务)

**职责**: [服务职责描述]

**核心方法**:
- `methodName(params)`: [方法描述]

**设计特点**:
- [特点1]
- [特点2]
```

### API端点变更
```markdown
**新增API端点**:
- `METHOD /api/path`: [端点描述]

**修改的API端点**:
- `METHOD /api/path`: [变更说明]
```

### 配置项变更
```markdown
### X. 新增配置

- `CONFIG_NAME`: [配置描述和用途]
```

## 质量保证

### 文档质量标准
- **准确性**: 与代码实现100%一致
- **完整性**: 覆盖所有重要的架构组件
- **可读性**: 结构清晰，描述准确
- **时效性**: 反映最新的系统状态

### 定期检查
- 每周检查一次文档与代码的一致性
- 每月进行一次全面的文档审查
- 重大版本发布前进行完整性检查

## 工具和自动化

### 建议的自动化工具
- Git hooks: 代码提交时提醒更新文档
- 文档生成工具: 从代码注释自动生成部分文档
- 一致性检查脚本: 定期检查文档与代码的一致性

### 手动检查清单
```markdown
- [ ] 服务类方法与文档描述一致
- [ ] API端点列表完整准确
- [ ] 数据模型定义正确
- [ ] 配置项说明完整
- [ ] 版本信息已更新
- [ ] 更新记录已添加
```

## 维护检查清单

### 每月检查
- [ ] 检查数据库连接状态
- [ ] 验证备份策略执行情况
- [ ] 检查日志文件大小和轮转
- [ ] 验证环境变量配置
- [ ] 检查依赖包安全更新
- [ ] 清理临时调试脚本和文件
- [ ] 验证数据一致性（使用诊断脚本）

### 每季度检查
- [ ] 性能基准测试
- [ ] 安全漏洞扫描
- [ ] 代码质量分析
- [ ] 文档更新检查
- [ ] 灾难恢复测试
- [ ] 代码库清理和重构评估

## 代码清理标准化流程

### 1. 测试数据管理规范
- 服务器启动默认不创建测试数据
- 需要测试数据时设置环境变量: `CREATE_TEST_DATA=true`
- 测试数据脚本统一放在 `scripts/` 目录
- 测试数据创建应该是幂等的，避免重复数据

### 2. 调试脚本管理规范
- 新调试脚本应放在 `scripts/debug/` 目录（待创建）
- 临时脚本命名格式: `temp_[功能]_[日期].js`
- 调试完成后及时清理临时脚本
- 有长期价值的脚本移动到 `archive/` 目录
- 重要的诊断工具应该正式化并添加文档

### 3. 数据一致性验证流程
- 使用 `diagnose_server_memory_state.js` 检查服务器状态
- 使用 `diagnose_data_inconsistency.js` 检查本地数据库状态
- 确保API返回数据与数据库状态完全一致
- 定期运行一致性检查，特别是在部署后

### 4. 文件组织规范
```
backend/
├── src/                    # 核心源代码
├── scripts/               # 正式脚本
│   ├── debug/            # 调试脚本（待创建）
│   └── maintenance/      # 维护脚本（待创建）
├── archive/              # 历史脚本存档
├── docs/                 # 文档
├── backup_*/            # 代码备份
└── 其他配置文件
```

---

**重要提醒**: 这个维护指南本身也需要根据实际使用情况进行更新和完善。