# 邮件功能重写架构规划

## 项目背景

原有邮件功能存在严重的"屎山代码"问题：
- 3个不同的邮件服务（emailService.js, emailServiceNew.js, emailServiceSimplified.js）
- 多套重复路由系统
- 数据映射不一致
- 模板系统混乱
- 技术债务严重

**决定：完全重写邮件功能**

## 清理完成情况

✅ **已删除的后端文件：**
- `src/services/emailService.js`
- `src/services/emailServiceNew.js`
- `src/services/emailServiceSimplified.js`
- `src/services/emailTemplateAdapter.js`
- `src/services/frenchTemplateSelector.js`
- `src/services/invoiceSendingService.js`
- `src/routes/emailConfig.js`
- `src/routes/emailTemplates.js`
- `src/routes/invoiceSending.js`
- `src/routes/outputServicesNew.js`
- `src/controllers/emailController.js`
- `src/models/emailTemplate.js`
- `src/models/EmailConfig.js`
- `src/services/ai/reminderEmailService.js`
- `templates/invoice.html`

✅ **已删除的前端文件：**
- `src/components/EmailConfigTest.js`
- `src/components/EmailConfigManager.js`
- `src/components/InvoiceSendingPanel.js`

✅ **已清理的依赖：**
- 移除了 `nodemailer`、`resend`、`@sendgrid/mail` 等邮件相关依赖

## 新架构设计原则

### 1. 单一职责原则
- 一个统一的邮件服务
- 清晰的模块分离
- 明确的接口定义

### 2. 配置驱动
- 统一的配置管理
- 支持多种邮件服务商
- 环境变量驱动

### 3. 模板系统
- 统一的模板引擎
- 支持多语言
- 易于维护和扩展

### 4. 错误处理
- 完善的错误处理机制
- 详细的日志记录
- 优雅的降级策略

## 技术栈选择

### 后端
- **邮件服务：** Nodemailer（成熟稳定）
- **模板引擎：** Handlebars（简单易用）
- **配置管理：** 环境变量 + 数据库
- **日志系统：** Winston

### 前端
- **UI组件：** React + Tailwind CSS
- **状态管理：** React Hooks
- **表单处理：** React Hook Form

## 核心模块设计

### 1. 邮件服务核心 (EmailService)
```
src/services/email/
├── EmailService.js          # 核心邮件服务
├── providers/               # 邮件服务商适配器
│   ├── SMTPProvider.js     # SMTP通用适配器
│   ├── GmailProvider.js    # Gmail专用适配器
│   └── OutlookProvider.js  # Outlook专用适配器
├── templates/              # 邮件模板
│   ├── TemplateEngine.js   # 模板引擎
│   └── templates/          # 模板文件
└── utils/                  # 工具函数
    ├── validator.js        # 邮件验证
    └── formatter.js        # 内容格式化
```

### 2. 配置管理 (ConfigManager)
```
src/services/email/config/
├── ConfigManager.js        # 配置管理器
├── providers.json          # 服务商配置
└── defaults.json          # 默认配置
```

### 3. 路由系统 (Routes)
```
src/routes/email/
├── index.js               # 路由入口
├── config.js              # 配置相关路由
├── sending.js             # 发送相关路由
└── templates.js           # 模板相关路由
```

### 4. 前端组件 (Components)
```
src/components/Email/
├── EmailConfig/           # 邮件配置组件
├── EmailSending/          # 邮件发送组件
├── EmailTemplates/        # 模板管理组件
└── EmailHistory/          # 发送历史组件
```

## 数据库设计

### 邮件配置表 (email_configs)
```sql
CREATE TABLE email_configs (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    provider VARCHAR(50) NOT NULL,
    smtp_host VARCHAR(255),
    smtp_port INTEGER,
    smtp_secure BOOLEAN,
    username VARCHAR(255),
    password TEXT, -- 加密存储
    is_active BOOLEAN DEFAULT true,
    is_verified BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### 邮件发送记录表 (email_logs)
```sql
CREATE TABLE email_logs (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    invoice_id INTEGER,
    recipient_email VARCHAR(255) NOT NULL,
    subject VARCHAR(500),
    status VARCHAR(50), -- 'sent', 'failed', 'pending'
    error_message TEXT,
    sent_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);
```

## API 接口设计

### 配置管理
- `GET /api/email/config` - 获取邮件配置
- `POST /api/email/config` - 保存邮件配置
- `PUT /api/email/config` - 更新邮件配置
- `DELETE /api/email/config` - 删除邮件配置
- `POST /api/email/config/test` - 测试邮件配置

### 邮件发送
- `POST /api/email/send/invoice` - 发送发票邮件
- `POST /api/email/send/test` - 发送测试邮件
- `POST /api/email/send/batch` - 批量发送邮件

### 历史记录
- `GET /api/email/history` - 获取发送历史
- `GET /api/email/history/:id` - 获取单条记录详情

## 实施计划

### 第一阶段：核心架构 (1-2天)
1. 创建新的目录结构
2. 实现核心邮件服务
3. 设计数据库表结构
4. 实现基本的配置管理

### 第二阶段：功能实现 (2-3天)
1. 实现邮件发送功能
2. 创建模板系统
3. 实现前端配置界面
4. 添加错误处理和日志

### 第三阶段：集成测试 (1-2天)
1. 集成到现有系统
2. 全面测试各种场景
3. 性能优化
4. 文档编写

### 第四阶段：部署上线 (1天)
1. 数据迁移（如需要）
2. 生产环境部署
3. 监控和维护

## 质量保证

### 测试策略
- 单元测试：核心服务和工具函数
- 集成测试：API接口和数据库操作
- 端到端测试：完整的邮件发送流程

### 代码质量
- ESLint + Prettier 代码规范
- 详细的代码注释
- 完整的错误处理
- 性能监控

## 风险评估

### 技术风险
- **低风险：** 使用成熟的技术栈
- **缓解措施：** 充分的测试和文档

### 业务风险
- **中风险：** 邮件功能中断可能影响用户体验
- **缓解措施：** 分阶段部署，保留回滚方案

### 时间风险
- **低风险：** 预估时间充足
- **缓解措施：** 优先实现核心功能，次要功能可后续迭代

## 成功标准

1. ✅ 邮件发送成功率 > 95%
2. ✅ 配置界面用户友好
3. ✅ 代码结构清晰，易于维护
4. ✅ 完整的错误处理和日志
5. ✅ 支持主流邮件服务商
6. ✅ 响应时间 < 3秒

---

**准备就绪，可以开始重写邮件功能！** 🚀