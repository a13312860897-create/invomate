# 发票数据流分析报告

## 📊 概述
本报告分析了发票邮件中各个数据的输入来源，确保所有测试数据能够正确替换为正式数据。

## 🏢 公司信息数据来源

### 当前使用的测试数据：
```
公司名：Invoice SaaS Company
地址：456 Business Avenue
城市：67890 Business City
电话：+86 123 4567 8900
邮箱：contact@invoice-saas.com
SIRET：98765432109876
```

### 正式数据来源：
1. **用户注册信息** (`User` 模型)
   - `companyName` - 用户注册时填写的公司名称
   - `address` - 公司地址
   - `city` - 城市
   - `postalCode` - 邮政编码
   - `country` - 国家
   - `phone` - 联系电话
   - `email` - 邮箱地址
   - `siretNumber` - SIRET号码（法国专用）
   - `vatNumber` - VAT税号

2. **法国专用字段**（当 `invoiceMode = 'france'` 时）
   - `siren` - SIREN号码（9位）
   - `legalForm` - 公司法律形式
   - `registeredCapital` - 注册资本
   - `rcsNumber` - RCS号码
   - `nafCode` - NAF代码

## 👥 客户信息数据来源

### 当前测试数据：
```
客户名：Test User
公司：Test Company
地址：123 Test Street
城市：12345 Test City
国家：China
SIRET：12345678901234
邮箱：a13312860897@163.com
```

### 正式数据来源：
1. **客户模型** (`Client` 模型)
   - `name` - 客户姓名
   - `company` - 客户公司名称
   - `email` - 客户邮箱
   - `phone` - 客户电话
   - `address` - 客户地址
   - `city` - 客户城市
   - `postalCode` - 客户邮政编码
   - `country` - 客户国家
   - `siret` - 客户SIRET号码
   - `vatNumber` - 客户VAT税号

## 📋 发票基本信息来源

### 当前测试数据：
```
发票号：TEST-2024-001
日期：15/01/2024
到期日：15/02/2024
状态：pending
金额：1,250.00 €
```

### 正式数据来源：
1. **发票模型** (`Invoice` 模型)
   - `invoiceNumber` - 发票编号（自动生成或手动输入）
   - `issueDate` - 开票日期
   - `dueDate` - 到期日期
   - `status` - 发票状态（draft, sent, paid, overdue, cancelled）
   - `total` - 总金额
   - `subtotal` - 小计
   - `taxAmount` - 税额

2. **发票编号生成规则**：
   - 法国模式：`FR{年份}{时间戳}`
   - 国际模式：用户自定义格式

## 🛍️ 发票项目数据来源

### 当前测试数据：
```
Web Development Services - 20单位 × 50,00 € = 1 000,00 €
UI/UX Design - 10单位 × 25,00 € = 250,00 €
```

### 正式数据来源：
1. **发票项目模型** (`InvoiceItem` 模型)
   - `description` - 项目描述
   - `quantity` - 数量
   - `unitPrice` - 单价
   - `taxRate` - 税率
   - `taxAmount` - 税额
   - `total` - 小计

2. **税率设置** (`TaxSetting` 模型)
   - 用户可配置的默认税率
   - 法国专用税率选项（0%, 2.1%, 5.5%, 10%, 20%）

## 📝 备注和条款数据来源

### 当前测试数据：
```
备注：Thank you for your business. Payment due within 30 days.
条款：Payment terms: 30 days from invoice date. Late payment fee: 1.5% per month.
```

### 正式数据来源：
1. **发票备注** (`Invoice.notes`)
   - 用户输入的备注信息

2. **默认条款**（系统预设）
   - 法国模式："Paiement à réception de la facture"
   - 国际模式："Payment due within 30 days"

## 🔍 数据流路径分析

### 1. 发票创建流程：
```
前端表单 → API请求 → 数据验证 → 数据库保存 → 邮件发送
```

### 2. 邮件发送流程：
```
发票ID → 查询发票数据 → 查询客户数据 → 查询用户数据 → 生成邮件内容 → 发送邮件
```

### 3. 数据标准化流程：
```
原始数据 → 标准化处理 → 模板渲染 → 最终输出
```

## ⚠️ 需要检查的关键点

### 1. 数据完整性检查：
- ✅ 用户公司信息是否完整
- ✅ 客户信息是否完整  
- ✅ 发票项目数据是否完整
- ✅ 税率设置是否正确

### 2. 数据一致性检查：
- ✅ 发票编号格式是否统一
- ✅ 日期格式是否正确（DD/MM/YYYY）
- ✅ 货币格式是否正确（€）
- ✅ 税率计算是否准确

### 3. 法语本地化检查：
- ✅ 所有标签是否已法语化
- ✅ 日期格式是否符合法国习惯
- ✅ 数字格式是否符合法国习惯（空格分隔符）

## 🔧 建议的上线前检查清单

### 用户数据验证：
- [ ] 检查所有用户的 `companyName`, `address`, `city`, `siretNumber` 是否填写
- [ ] 验证法国用户是否填写了 `siren`, `vatNumber` 等法国专用字段
- [ ] 确认用户邮箱和电话格式正确

### 客户数据验证：
- [ ] 检查所有客户的 `name`, `email`, `address` 是否完整
- [ ] 验证法国客户的 `siret`, `vatNumber` 是否填写
- [ ] 确认客户邮箱格式正确

### 系统配置验证：
- [ ] 检查默认税率设置是否正确
- [ ] 验证邮件配置是否正常工作
- [ ] 确认PDF模板显示正常
- [ ] 测试发票邮件发送功能

### 数据备份：
- [ ] 备份当前所有用户数据
- [ ] 备份客户数据
- [ ] 备份发票数据

## 🎯 总结

当前的发票邮件系统已经具备了完整的数据链路，所有测试数据都有对应的正式数据来源。主要需要确保：

1. **用户完整填写公司信息** - 特别是法国用户需要填写SIRET等专用字段
2. **客户信息完整** - 确保所有客户都有完整的联系信息
3. **税率设置正确** - 根据业务模式选择合适的税率
4. **邮件配置正常** - 确保SMTP设置正确，能够正常发送邮件

系统已准备好上线，只需要确保所有用户和客户的数据完整性即可。