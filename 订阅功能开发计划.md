# 订阅功能开发计划

## 项目概述
实现简化的订阅功能，主要控制发票创建权限，通过试用期倒计时管理用户访问。

## 功能需求

### 1. 核心订阅逻辑（已完成）
- ✅ 订阅设置页面
- ✅ 功能权限控制系统 (`useSubscriptionFeatures` Hook)
- ✅ 页面集成功能权限控制组件

### 2. 简化的订阅控制策略
**核心原则：** 付费完成后增加使用时间，时间结束后禁用发票创建功能

#### 2.1 权限控制范围
- **主要限制：** 发票创建页面访问权限
- **次要限制：** 导出功能（可选）
- **不限制：** 查看已有发票、客户管理、基础设置

#### 2.2 订阅状态判断
```javascript
// 简化的订阅状态
const subscriptionStatus = {
  isActive: boolean,        // 是否在有效期内
  expiresAt: Date,         // 到期时间
  daysRemaining: number,   // 剩余天数
  isTrialUser: boolean     // 是否试用用户
}
```

### 3. 试用期倒计时显示（待开发）

#### 3.1 右上角菜单倒计时
**位置：** 用户头像下拉菜单中
**显示内容：**
- 试用期用户：`试用期剩余 X 天`
- 付费用户：`订阅剩余 X 天`
- 已过期：`订阅已过期`

**样式要求：**
- 简洁明了，不占用过多空间
- 剩余天数 ≤ 3 天时显示警告色（橙色/红色）
- 已过期时显示红色

#### 3.2 实现方案
```javascript
// 在用户菜单组件中添加
const SubscriptionCountdown = () => {
  const { daysRemaining, isActive } = useSubscriptionFeatures();
  
  if (!isActive) return <span className="text-red-500">订阅已过期</span>;
  if (daysRemaining <= 3) return <span className="text-orange-500">剩余 {daysRemaining} 天</span>;
  return <span className="text-gray-600">剩余 {daysRemaining} 天</span>;
};
```

### 4. 到期前提醒通知（待开发）

#### 4.1 提醒触发条件
- **时机：** 用户登录时检查
- **频率：** 每天最多提醒一次
- **触发条件：** 剩余天数 ≤ 3 天

#### 4.2 提醒内容
**消息模板：**
```
您的使用时间还剩 X 天，请及时续订。
```

#### 4.3 实现方案
```javascript
// 在登录后或应用启动时检查
const checkSubscriptionExpiry = () => {
  const { daysRemaining, isActive } = useSubscriptionFeatures();
  const lastNotified = localStorage.getItem('lastExpiryNotification');
  const today = new Date().toDateString();
  
  if (isActive && daysRemaining <= 3 && lastNotified !== today) {
    showNotification(`您的使用时间还剩 ${daysRemaining} 天，请及时续订。`);
    localStorage.setItem('lastExpiryNotification', today);
  }
};
```

### 5. 支付集成（复杂功能，后续开发）

#### 5.1 支付流程设计
1. 用户选择订阅计划
2. 跳转到 Paddle 支付页面
3. 支付成功后回调处理
4. 更新用户订阅状态（增加使用时间）

#### 5.2 技术实现要点
- Paddle 支付集成
- Webhook 处理支付回调
- 订阅时间计算和更新
- 支付记录存储

## 当前技术问题（需要修复）

### Bug 列表
1. ❌ AuthContext 导入路径错误
2. ❌ 前端编译错误导致页面无法正常加载
3. ❌ 功能权限组件可能存在的逻辑问题

### 修复优先级
1. **高优先级：** 修复导入路径和编译错误
2. **中优先级：** 测试功能权限控制是否正常工作
3. **低优先级：** 优化用户体验和错误处理

## 开发时间线

### 第一阶段：Bug修复（当前）
- [ ] 修复所有导入路径错误
- [ ] 解决前端编译问题
- [ ] 测试基础功能是否正常

### 第二阶段：倒计时功能开发
- [ ] 实现右上角菜单倒计时显示
- [ ] 添加登录时的到期提醒
- [ ] 测试倒计时和提醒功能

### 第三阶段：支付集成（后续）
- [ ] Paddle 支付页面集成
- [ ] Webhook 回调处理
- [ ] 订阅时间管理
- [ ] 完整流程测试

## 技术架构

### 前端组件结构
```
src/
├── hooks/
│   └── useSubscriptionFeatures.js    # 订阅功能Hook
├── components/
│   ├── FeatureGate.js                # 功能权限控制
│   └── SubscriptionCountdown.js      # 倒计时组件（待创建）
├── pages/
│   └── SubscriptionSettings.js       # 订阅设置页面
└── services/
    └── subscriptionService.js        # 订阅相关API
```

### 后端API设计
```
GET  /api/subscription/status         # 获取订阅状态
POST /api/subscription/extend         # 延长订阅时间
POST /api/webhook/paddle             # Paddle支付回调
```

## 测试计划

### 功能测试
1. 试用期用户权限测试
2. 付费用户权限测试
3. 过期用户权限测试
4. 倒计时显示测试
5. 到期提醒测试

### 集成测试
1. 支付流程端到端测试
2. Webhook 回调测试
3. 订阅状态同步测试

## 注意事项

1. **简化优先：** 避免过度复杂的订阅计划，专注核心功能
2. **用户体验：** 确保过期提醒不会过于打扰用户
3. **数据安全：** 支付相关数据需要安全处理
4. **错误处理：** 支付失败、网络异常等情况的处理

---

**文档创建时间：** 2025年1月27日  
**最后更新：** 2025年1月27日  
**状态：** 进行中