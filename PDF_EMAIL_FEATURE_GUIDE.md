# PDF邮件发送功能使用指南

## 功能概述
新增的PDF邮件发送功能允许用户直接从发票详情页面生成PDF并通过邮件发送给客户。

## 功能特点
- 🎯 **一键发送**: 直接从发票详情页面发送PDF邮件
- 📧 **自定义邮件**: 支持自定义收件人、主题和邮件内容
- 📄 **自动PDF生成**: 复用现有的PDF生成功能
- ✅ **实时反馈**: 提供发送状态和错误提示
- 🔒 **安全可靠**: 使用现有的认证和权限系统

## 如何使用

### 1. 访问发票详情页面
- 登录系统后，进入任意发票的详情页面
- 在页面右上角的操作按钮区域，您会看到新增的"PDF邮件发送"按钮

### 2. 发送PDF邮件
1. 点击"PDF邮件发送"按钮
2. 在弹出的对话框中填写：
   - **收件人邮箱**: 客户的邮箱地址
   - **邮件主题**: 默认为"发票 - [发票号]"，可自定义
   - **自定义内容**: 可选的额外邮件内容
3. 点击"发送邮件"按钮
4. 等待发送完成，系统会显示成功或失败的提示

### 3. 发送状态
- ✅ **成功**: 显示绿色成功提示
- ❌ **失败**: 显示红色错误提示，包含具体错误信息
- ⏳ **发送中**: 显示加载状态

## 技术实现

### 后端API
- **路由**: `/api/pdf-email/send/:invoiceId`
- **方法**: POST
- **功能**: 生成PDF并发送邮件

### 前端组件
- **PDFEmailSender**: 邮件发送对话框组件
- **集成位置**: InvoiceDetail页面

### 邮件配置
系统使用以下SMTP配置（已在.env中设置）：
- SMTP服务器: smtp.163.com
- 端口: 465
- 安全连接: SSL/TLS

## 注意事项

1. **邮件配置**: 确保后端的SMTP配置正确
2. **网络连接**: 需要稳定的网络连接发送邮件
3. **文件大小**: PDF文件大小受邮件服务器限制
4. **权限验证**: 只有有权限访问发票的用户才能发送邮件

## 故障排除

### 常见问题
1. **发送失败**: 检查SMTP配置和网络连接
2. **PDF生成失败**: 检查发票数据完整性
3. **权限错误**: 确保用户有访问该发票的权限

### 错误代码
- `401`: 未授权访问
- `404`: 发票不存在
- `500`: 服务器内部错误（通常是SMTP配置问题）

## 开发信息

### 文件结构
```
backend/
├── src/services/
│   ├── emailService.js          # 邮件发送服务
│   └── pdfEmailService.js       # PDF邮件集成服务
├── src/routes/
│   └── pdfEmail.js              # PDF邮件API路由
frontend/
├── src/components/
│   ├── PDFEmailSender.js        # 邮件发送组件
│   └── PDFEmailSender.css       # 组件样式
└── src/pages/
    └── InvoiceDetail.js         # 集成页面
```

### 依赖包
- **nodemailer**: 邮件发送库
- **react-hot-toast**: 前端提示组件

---

**版本**: 1.0.0  
**更新日期**: 2024年12月  
**开发状态**: ✅ 已完成