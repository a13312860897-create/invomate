# 支付集成最终任务

为保障主线开发稳定，我们已暂时冻结 Paddle 支付集成子项目。此文档统筹当前集成状态、关键改动、重新激活步骤、环境配置清单、测试验收方案，以及本次清理掉的历史文档列表。保留所有代码实现，便于后续随时恢复。

## 当前集成状态概览

- 前端支付页：`/pricing`（`frontend/src/pages/PaddlePricing.js`）动态加载 Paddle SDK，使用 Client Token 初始化并根据计划/周期创建交易。
- 交易创建：
  - 后端路由：`POST /api/paddle/create-payment-link`（`backend/src/routes/paddle.js`），使用 Paddle Platform API 创建 `transaction`，附带 `success_url` 与 `cancel_url`。
  - 边缘函数（可选）：`frontend/netlify/functions/paddle-create-transaction.js`，同样调用 Platform API 并返回 `checkoutUrl`（已补充 `Paddle-Version: 1` 头）。
- 成功页：`/payment-success`（`frontend/src/pages/PaymentSuccessPage.js`）从 URL 获取 `transaction_id`/`subscription_id`，等待 Webhook 入库后刷新订阅状态并指引跳转。
- Webhook 验证：`frontend/netlify/functions/paddle-webhook.js` 以 `PADDLE_WEBHOOK_SECRET` 对原始请求体执行 HMAC-SHA256 校验；验证通过后转发至后端 `POST /api/paddle/webhook` 并添加 `X-Paddle-Verified: true` 头。
- 后端 Webhook 信任：`backend/src/routes/paddle.js` 在生产环境下信任来自边缘函数并附带 `X-Paddle-Verified: true` 的请求；开发环境跳过签名校验，便于联调。

## 已完成的关键修复

- 在 Netlify 交易创建函数添加请求头：`Paddle-Version: 1`，确保 Platform API 的版本化语义一致。
- 后端 Webhook 路由在生产环境尊重 `X-Paddle-Verified: true`，拒绝未经边缘签名校验的直接调用；开发环境放宽校验规则。

## 重新激活步骤（生产环境）

1. Paddle Dashboard 配置
   - Approved Websites：添加并审核生产域名（例如：`https://invomate.app`）。
   - Default Payment Link：设为 `https://invomate.app/pricing`（或别名 `https://invomate.app/paddle-pricing`）。
   - Webhooks：将通知目标指向边缘函数或后端入口，推荐：`https://<your-site>.netlify.app/.netlify/functions/paddle-webhook`。

2. 环境变量配置
   - 前端（`frontend/.env.production`）：
     - `REACT_APP_PADDLE_CLIENT_TOKEN`（Paddle Client Token，勿在后端泄露）。
     - `REACT_APP_PADDLE_ENVIRONMENT=production`
     - `REACT_APP_USE_NETLIFY_FUNCTIONS=true`（如需走 Netlify 函数创建交易）。
     - `REACT_APP_API_URL=https://<your-backend-host>`（前后端一致域名策略）。
   - 后端（环境注入或 `.env`）与边缘函数（Netlify）：
     - `PADDLE_API_KEY`（Platform API Key，仅后端/函数使用）。
     - `PADDLE_WEBHOOK_SECRET`
     - `PADDLE_ENVIRONMENT=production`
     - 价格 ID 映射，如：`PADDLE_BASIC_MONTHLY_PRICE_ID`、`PADDLE_BASIC_YEARLY_PRICE_ID`、`PADDLE_PRO_MONTHLY_PRICE_ID`、`PADDLE_PRO_YEARLY_PRICE_ID` 等。
     - `BACKEND_URL` 或 `RENDER_BACKEND_URL`（Webhook 转发目的地）。

3. 成功/取消跳转 URL
   - 统一由后端/函数创建 `transaction` 时注入：
     - `success_url=https://invomate.app/payment-success`
     - `cancel_url=https://invomate.app/pricing`
   - 如需透传 `transaction_id`/`subscription_id`，在成功页解析并刷新订阅状态。

4. 联调与测试（Sandbox → Production）
   - Sandbox：启用 `PADDLE_ENVIRONMENT=sandbox`，校验交易创建、`checkoutUrl` 重定向与成功页流程。
   - Webhook：验证签名校验链路（边缘函数 HMAC 校验 → 后端 `X-Paddle-Verified` 信任）。
   - 事件覆盖：`transaction.created/updated/completed`，`subscription.*`，确保后端入库与前端刷新协同。
   - 默认支付链接缺失检测：若 Dashboard 未设置 Default Payment Link，Paddle 可能返回不可用 `checkout.url`；务必先完成域名与默认链接配置。

## 涉及的关键代码文件（保留）

- 前端页面与服务：
  - `frontend/src/pages/PaddlePricing.js`
  - `frontend/src/pages/PaymentSuccessPage.js`
  - `frontend/src/services/paddleService.js`
- Netlify Functions：
  - `frontend/netlify/functions/paddle-create-transaction.js`
  - `frontend/netlify/functions/paddle-webhook.js`
- 后端路由与服务：
  - `backend/src/routes/paddle.js`
  - `backend/src/services/paddleService.js`

## 风险与注意事项

- 切勿在前端暴露 `PADDLE_API_KEY`；前端仅使用 `Client Token`。
- Webhook 签名基于“原始请求体”计算；确保边缘函数按原文转发，并在生产中仅接受 `X-Paddle-Verified: true`。
- 仅在 Paddle Dashboard 完成域名审核与默认支付链接配置后再上线；否则 `checkout.url` 可能不可用。
- 若切回 Stripe 或多支付渠道策略，需另立集成文档与环境隔离，不与本子项目混用变量与路由。

## 本次清理的历史文档列表

为避免信息分散与重复，此次仅保留本总结文档，删除以下与支付集成相关的历史文档：

- `NETLIFY_PADDLE_SETUP_GUIDE.md`
- `PADDLE_INTEGRATION_TASK_PLAN.md`
- `PADDLE_PAYMENT_FIX_GUIDE.md`
- `PADDLE_SETUP_GUIDE.md`
- `PADDLE_VENDOR_ID_GUIDE.md`
- `Paddle发票快捷支付方案.md`
- `docs/Paddle使用说明.md`
- `docs/Paddle快速入门指南.md`
- `docs/Paddle支付集成耦合分析报告.md`
- `docs/Paddle沙盒模式测试总结.md`
- `docs/Paddle集成指南.md`
- `docs/支付功能修复测试指南.md`

如需恢复或扩展，请以本总结为唯一依据重新创建任务与文档。