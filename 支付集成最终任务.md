# 支付集成最终任务（重写版 / 分阶段）

本文件系统化记录支付集成的目标、分阶段任务、当前进度、接口与环境配置，以及联调与排查方法。用于团队内部协作与长期记忆，也便于其他 AI 助手快速接入并延续工作。

## 一、项目概览
- 目标：完成基于 Paddle Platform API 的订阅与发票支付集成，覆盖交易创建、Webhook 安全校验、用户与订阅数据同步、部署与联调、生产化运行。
- 技术要点：
  - 后端：`Express`、`axios`、`Paddle Platform API`（`Paddle-Version: 1`）、少量 `Classic API` 保留。
  - 安全：Webhook 原始体解析 + HMAC 签名校验（兼容多种头部）。
  - 部署：Vultr + Nginx 反向代理 + Let's Encrypt SSL + PM2 进程管理。
  - 前端：API 基地址指向 `https://api.invomate.app`，成功/取消回调 URL 配置。

## 二、进度总览（里程碑）
- 已完成（Completed）
  - Webhook 原始体解析与 HMAC 签名校验（兼容 `paddle-signature`/`x-paddle-signature`/`x-paddle-signature-hmac`），生产环境强制校验或信任边缘 `X-Paddle-Verified=true`。
  - `Paddle-Version: '1'` 头部已在平台 API 客户端设置，锁定 v1。
  - 交易创建路由与客户创建/获取，价格 ID 来自环境变量。
  - `transaction.completed` 事件处理：新增事件映射并委派到发票支付服务；无发票令牌时按订阅购买更新用户到期时间。
  - 取消订阅改用 Platform API：`POST /subscriptions/{id}/cancel`。
  - Vultr 部署指南（DNS、Nginx、SSL、环境变量、CORS、PM2）。
- 进行中（In Progress）
  - 沙盒端到端联调与验收（依据下方步骤执行）。
- 待办（Todo）
  - 更细的支付状态存储与对账日志。
  - 退款、收据、支付失败重试与催收（dunning）。
  - 订阅生命周期事件的更全面映射与通知。

## 三、分阶段任务与进展

### 阶段 0：架构与依赖（Completed）
- `backend/src/services/paddleService.js` 同时保留 Classic 与 Platform 客户端；平台端设置 `Authorization: Bearer <PADDLE_API_KEY>` 与 `Paddle-Version: '1'`。
- 关键环境变量：`PADDLE_ENVIRONMENT`、`PADDLE_API_KEY`、`PADDLE_WEBHOOK_SECRET`、`FRONTEND_URL`、价格 ID。

### 阶段 1：Webhook 安全与原始体解析（Completed）
- `backend/src/server.js` 在全局 JSON 解析器之前注册 `app.use('/api/paddle/webhook', express.raw({ type: 'application/json' }))`。
- `backend/src/routes/paddle.js` 执行 HMAC 校验或信任边缘验证，并优先基于原始体解析事件。
- 加强日志：记录使用的签名头类型与长度、`edgeVerified` 状态，便于生产排查。

### 阶段 2：交易创建与客户管理（Completed）
- `POST /api/paddle/create-payment-link`：创建交易并返回 `checkoutUrl` 与 `transactionId`。
- 客户创建/获取：优先使用 `paddleCustomerId`，不存在时创建并保存。
- 价格 ID 由环境变量注入，避免调用 Paddle 时配置缺失。

### 阶段 3：发票直接支付链路（Completed）
- `backend/src/services/invoicePaymentService.js`
  - 生成安全令牌保存至 `Prisma`（`invoicePaymentToken` 表），过期与幂等校验。
  - 创建交易时在 `custom_data` 内嵌入发票 ID 与令牌，便于 Webhook 回写。
  - Webhook `transaction.completed` 事件委派至该服务，标记令牌使用并可扩展发票状态更新与通知。
- 修复：新增 `transaction.completed` 事件映射（此前仅有 `payment.succeeded`），避免事件未处理。

### 阶段 4：订阅同步与取消（Partially Completed）
- `subscriptionSyncService` 负责订阅事件处理与状态映射；后续完善更多事件场景与通知。
- 取消订阅：已从 Classic 切换至 Platform API `POST /subscriptions/{id}/cancel`。

### 阶段 5：Vultr 部署与网络（Completed）
- DNS：`api.invomate.app` 指向 Vultr 公网 IP。
- Nginx：HTTP → HTTPS 重定向；HTTPS 反向代理至 `127.0.0.1:8080`。
- SSL：Let's Encrypt（`certbot`）签发；自动或手动配置证书路径。
- 进程：`pm2` 管理 Node 服务；健康检查 `GET /api/health`。
- CORS：`FRONTEND_URL` 与 `ALLOWED_ORIGINS` 注入白名单。

### 阶段 6：前端对接（In Progress）
- API 基地址：`https://api.invomate.app`。
- Checkout 回调：成功 `success_url`、取消 `cancel_url` 指向前端对应页面。

### 阶段 7：沙盒联调与验收（In Progress）
- 健康检查：`GET https://api.invomate.app/api/health`。
- 创建交易：
  - `POST https://api.invomate.app/api/paddle/create-payment-link`
  - Body 示例：`{"plan":"professional","billingCycle":"monthly","successUrl":"https://invomate.app/payment-success","cancelUrl":"https://invomate.app/pricing?cancelled=true"}`
  - 头部：`Authorization: Bearer <JWT>`
- 完成一次沙盒支付，观察后端日志：
  - 签名头与 `edgeVerified` 状态；`Processing Paddle webhook event: transaction.completed`；委派发票或订阅流程日志。

### 阶段 8：生产上线与监控（Todo）
- 在 Paddle 控制台配置 Default Checkout URL，避免 `transaction_default_checkout_url_not_set`。
- 监控：Nginx/应用日志、Webhook 成功率、交易创建错误码分布。
- 告警：签名校验失败率阈值、交易失败趋势、订阅状态漂移。

### 阶段 9：排查与回滚策略（Ready）
- 签名校验失败：核对 `PADDLE_WEBHOOK_SECRET`，检查使用的签名头与原始体解析是否被错误拦截。
- 权限错误（401/403）：核对 `PADDLE_API_KEY` 与环境（`sandbox`/`production`）。
- 无 `checkoutUrl`：在控制台设置 Default Checkout URL。
- 临时回退：`USE_MOCK_PAYMENT='true'`（开发环境）以保障演示流程。

## 四、关键接口与文件索引
- 路由文件：`backend/src/routes/paddle.js`
  - `POST /api/paddle/create-payment-link`
  - `POST /api/paddle/webhook`
  - `POST /api/paddle/cancel-subscription`
  - `GET /api/paddle/billing-history`
- 服务文件：
  - `backend/src/services/paddleService.js`（Platform/Classic 客户端、事件分发、取消订阅）
  - `backend/src/services/invoicePaymentService.js`（发票令牌、交易创建、Webhook 处理）
  - `backend/src/services/subscriptionSyncService.js`（订阅事件同步）
  - `backend/src/services/SubscriptionTimeManager.js`（到期时间计算）
- 服务器：`backend/src/server.js`（Webhook 原始体解析、CORS 白名单、健康检查）

## 五、环境变量清单（后端）
- 必填：
  - `PADDLE_ENVIRONMENT`：`sandbox` 或 `production`
  - `PADDLE_API_KEY`：平台 API Key
  - `PADDLE_WEBHOOK_SECRET`：Webhook HMAC Secret
  - `FRONTEND_URL`：前端站点，例如 `https://invomate.app`
- 价格与产品：
  - `PADDLE_BASIC_MONTHLY_PRICE_ID` / `PADDLE_BASIC_YEARLY_PRICE_ID`
  - `PADDLE_PRO_MONTHLY_PRICE_ID` / `PADDLE_PRO_YEARLY_PRICE_ID`
- 其他：
  - `ALLOWED_ORIGINS`（逗号分隔）
  - `NODE_ENV`、`PORT`、数据库连接、`JWT_SECRET`

## 六、联调与验收用例（curl 示例）
- 创建交易：
  - `curl -X POST "https://api.invomate.app/api/paddle/create-payment-link" -H "Authorization: Bearer <JWT>" -H "Content-Type: application/json" -d '{"plan":"professional","billingCycle":"monthly"}'`
- Webhook 测试（本地或沙盒触发真实事件更可靠）：
  - 观察日志的签名头类型、校验结果与事件分发处理路径。
- 取消订阅：
  - `curl -X POST "https://api.invomate.app/api/paddle/cancel-subscription" -H "Authorization: Bearer <JWT>"`

## 七、风险与缓解
- 事件名不一致：已补充 `transaction.completed` 映射，发票与订阅两路处理。
- 生产签名失败：启用原始体解析、检查反向代理是否改写头部或请求体。
- 配置缺失：价格 ID 或默认 Checkout URL 未配置会导致交易创建失败。

## 八、后续迭代清单（建议）
- 支付/订阅状态入库与对账、失败重试与催收（dunning）。
- 退款与收据、发票状态联动通知。
- 更完整的订阅事件映射与用户提醒。
- 异常保护：接口幂等性、重复事件去重、并发处理策略。

—— 本文档将随联调与上线进度持续更新，用作团队与 AI 的共享长期记忆。

为保障主线开发稳定，我们已暂时冻结 Paddle 支付集成子项目。此文档统筹当前集成状态、关键改动、重新激活步骤、环境配置清单、测试验收方案，以及本次清理掉的历史文档列表。保留所有代码实现，便于后续随时恢复。

## 当前集成状态概览

- 前端支付页：`/pricing`（`frontend/src/pages/PaddlePricing.js`）动态加载 Paddle SDK，使用 Client Token 初始化并根据计划/周期创建交易。
- 交易创建：
  - 后端路由：`POST /api/paddle/create-payment-link`（`backend/src/routes/paddle.js`），使用 Paddle Platform API 创建 `transaction`，附带 `success_url` 与 `cancel_url`。
  - 边缘函数（可选）：`frontend/netlify/functions/paddle-create-transaction.js`，同样调用 Platform API 并返回 `checkoutUrl`（已补充 `Paddle-Version: 1` 头）。
- 成功页：`/payment-success`（`frontend/src/pages/PaymentSuccessPage.js`）从 URL 获取 `transaction_id`/`subscription_id`，等待 Webhook 入库后刷新订阅状态并指引跳转。
- Webhook 验证：`frontend/netlify/functions/paddle-webhook.js` 以 `PADDLE_WEBHOOK_SECRET` 对原始请求体执行 HMAC-SHA256 校验；验证通过后转发至后端 `POST /api/paddle/webhook` 并添加 `X-Paddle-Verified: true` 头。
- 后端 Webhook 信任：`backend/src/routes/paddle.js` 在生产环境下信任来自边缘函数并附带 `X-Paddle-Verified: true` 的请求；开发环境跳过签名校验，便于联调。

## 已完成的关键修复

- 在 Netlify 交易创建函数添加请求头：`Paddle-Version: 1`，确保 Platform API 的版本化语义一致。
- 后端 Webhook 路由在生产环境尊重 `X-Paddle-Verified: true`，拒绝未经边缘签名校验的直接调用；开发环境放宽校验规则。

## 重新激活步骤（生产环境）

1. Paddle Dashboard 配置
   - Approved Websites：添加并审核生产域名（例如：`https://invomate.app`）。
   - Default Payment Link：设为 `https://invomate.app/pricing`（或别名 `https://invomate.app/paddle-pricing`）。
   - Webhooks：将通知目标指向边缘函数或后端入口，推荐：`https://<your-site>.netlify.app/.netlify/functions/paddle-webhook`。

2. 环境变量配置
   - 前端（`frontend/.env.production`）：
     - `REACT_APP_PADDLE_CLIENT_TOKEN`（Paddle Client Token，勿在后端泄露）。
     - `REACT_APP_PADDLE_ENVIRONMENT=production`
     - `REACT_APP_USE_NETLIFY_FUNCTIONS=true`（如需走 Netlify 函数创建交易）。
     - `REACT_APP_API_URL=https://<your-backend-host>`（前后端一致域名策略）。
   - 后端（环境注入或 `.env`）与边缘函数（Netlify）：
     - `PADDLE_API_KEY`（Platform API Key，仅后端/函数使用）。
     - `PADDLE_WEBHOOK_SECRET`
     - `PADDLE_ENVIRONMENT=production`
     - 价格 ID 映射，如：`PADDLE_BASIC_MONTHLY_PRICE_ID`、`PADDLE_BASIC_YEARLY_PRICE_ID`、`PADDLE_PRO_MONTHLY_PRICE_ID`、`PADDLE_PRO_YEARLY_PRICE_ID` 等。
     - `BACKEND_URL` 或 `RENDER_BACKEND_URL`（Webhook 转发目的地）。

3. 成功/取消跳转 URL
   - 统一由后端/函数创建 `transaction` 时注入：
     - `success_url=https://invomate.app/payment-success`
     - `cancel_url=https://invomate.app/pricing`
   - 如需透传 `transaction_id`/`subscription_id`，在成功页解析并刷新订阅状态。

4. 联调与测试（Sandbox → Production）
   - Sandbox：启用 `PADDLE_ENVIRONMENT=sandbox`，校验交易创建、`checkoutUrl` 重定向与成功页流程。
   - Webhook：验证签名校验链路（边缘函数 HMAC 校验 → 后端 `X-Paddle-Verified` 信任）。
   - 事件覆盖：`transaction.created/updated/completed`，`subscription.*`，确保后端入库与前端刷新协同。
   - 默认支付链接缺失检测：若 Dashboard 未设置 Default Payment Link，Paddle 可能返回不可用 `checkout.url`；务必先完成域名与默认链接配置。

## 涉及的关键代码文件（保留）

- 前端页面与服务：
  - `frontend/src/pages/PaddlePricing.js`
  - `frontend/src/pages/PaymentSuccessPage.js`
  - `frontend/src/services/paddleService.js`
- Netlify Functions：
  - `frontend/netlify/functions/paddle-create-transaction.js`
  - `frontend/netlify/functions/paddle-webhook.js`
- 后端路由与服务：
  - `backend/src/routes/paddle.js`
  - `backend/src/services/paddleService.js`

## 风险与注意事项

- 切勿在前端暴露 `PADDLE_API_KEY`；前端仅使用 `Client Token`。
- Webhook 签名基于“原始请求体”计算；确保边缘函数按原文转发，并在生产中仅接受 `X-Paddle-Verified: true`。
- 仅在 Paddle Dashboard 完成域名审核与默认支付链接配置后再上线；否则 `checkout.url` 可能不可用。
- 若切回 Stripe 或多支付渠道策略，需另立集成文档与环境隔离，不与本子项目混用变量与路由。

## 本次清理的历史文档列表

为避免信息分散与重复，此次仅保留本总结文档，删除以下与支付集成相关的历史文档：

- `NETLIFY_PADDLE_SETUP_GUIDE.md`
- `PADDLE_INTEGRATION_TASK_PLAN.md`
- `PADDLE_PAYMENT_FIX_GUIDE.md`
- `PADDLE_SETUP_GUIDE.md`
- `PADDLE_VENDOR_ID_GUIDE.md`
- `Paddle发票快捷支付方案.md`
- `docs/Paddle使用说明.md`
- `docs/Paddle快速入门指南.md`
- `docs/Paddle支付集成耦合分析报告.md`
- `docs/Paddle沙盒模式测试总结.md`
- `docs/Paddle集成指南.md`
- `docs/支付功能修复测试指南.md`

如需恢复或扩展，请以本总结为唯一依据重新创建任务与文档。