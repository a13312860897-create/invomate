<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰åç«¯è¿æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .loading {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .complete {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .troubleshooting {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        .troubleshooting h3 {
            color: #495057;
            margin-top: 0;
        }
        .troubleshooting ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .troubleshooting li {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ å‰åç«¯è¿æ¥æµ‹è¯•</h1>
        
        <div id="status" class="status">
            ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•è¿æ¥çŠ¶æ€
        </div>
        
        <div style="text-align: center;">
            <button onclick="runAllTests()">ğŸ§ª è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <button onclick="runBasicTest()">ğŸ” åŸºç¡€è¿æ¥æµ‹è¯•</button>
            <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
        </div>
        
        <div id="results"></div>
        
        <div class="troubleshooting">
            <h3>ğŸ”§ æ•…éšœæ’é™¤æŒ‡å—</h3>
            <ul>
                <li><strong>åç«¯æœåŠ¡å™¨:</strong> ç¡®ä¿åç«¯è¿è¡Œåœ¨ http://localhost:3001</li>
                <li><strong>å‰ç«¯é…ç½®:</strong> æ£€æŸ¥å‰ç«¯ .env æ–‡ä»¶ä¸­çš„ REACT_APP_API_URL=http://localhost:3001</li>
                <li><strong>CORS é…ç½®:</strong> åç«¯åº”å…è®¸æ¥è‡ª http://localhost:3000 çš„è¯·æ±‚</li>
                <li><strong>ç«¯å£å†²çª:</strong> å¦‚æœç«¯å£è¢«å ç”¨ï¼Œå°è¯•ä½¿ç”¨ä¸åŒçš„ç«¯å£</li>
                <li><strong>é˜²ç«å¢™:</strong> ç¡®ä¿é˜²ç«å¢™æ²¡æœ‰é˜»æ­¢æœ¬åœ°è¿æ¥</li>
            </ul>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3001';
        const FRONTEND_URL = 'http://localhost:3000';
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.textContent = message;
        }
        
        function addResult(title, content, type = 'info') {
            const resultsEl = document.getElementById('results');
            const resultEl = document.createElement('div');
            resultEl.className = 'test-result ' + type;
            resultEl.innerHTML = `<strong>${title}</strong><br>${content}`;
            resultsEl.appendChild(resultEl);
        }
        
        async function testConnection(url, title) {
            try {
                const startTime = Date.now();
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'include',
                    timeout: 5000
                });
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                const result = {
                    status: response.status,
                    statusText: response.statusText,
                    responseTime: responseTime,
                    headers: Object.fromEntries(response.headers.entries())
                };
                
                let responseData = null;
                try {
                    responseData = await response.json();
                } catch (e) {
                    responseData = await response.text();
                }
                
                result.data = responseData;
                
                if (response.ok) {
                    addResult(title, 
                        `âœ… æˆåŠŸ (${response.status}) - ${responseTime}ms\n` +
                        `å“åº”: ${JSON.stringify(responseData, null, 2)}`, 'success');
                } else {
                    addResult(title, 
                        `âŒ å¤±è´¥ (${response.status} ${response.statusText}) - ${responseTime}ms\n` +
                        `å“åº”: ${JSON.stringify(responseData, null, 2)}`, 'error');
                }
                
                return result;
            } catch (error) {
                addResult(title, 
                    `âŒ é”™è¯¯: ${error.message}\n` +
                    `URL: ${url}`, 'error');
                return { error: error.message };
            }
        }
        
        async function runBasicTest() {
            clearResults();
            updateStatus('ğŸ” è¿è¡ŒåŸºç¡€è¿æ¥æµ‹è¯•...', 'loading');
            
            // æµ‹è¯•åç«¯åŸºç¡€è¿æ¥
            await testConnection(`${API_BASE_URL}/`, 'åç«¯åŸºç¡€è¿æ¥');
            
            // æµ‹è¯•å‰ç«¯é¡µé¢
            await testConnection(FRONTEND_URL, 'å‰ç«¯æœåŠ¡å™¨');
            
            updateStatus('âœ… åŸºç¡€è¿æ¥æµ‹è¯•å®Œæˆ', 'complete');
        }
        
        async function runAllTests() {
            clearResults();
            updateStatus('ğŸ§ª è¿è¡Œå®Œæ•´APIæµ‹è¯•...', 'loading');
            
            // åŸºç¡€è¿æ¥æµ‹è¯•
            await testConnection(`${API_BASE_URL}/`, 'åç«¯åŸºç¡€è¿æ¥');
            await testConnection(FRONTEND_URL, 'å‰ç«¯æœåŠ¡å™¨');
            
            // API è·¯ç”±æµ‹è¯•
            const apiRoutes = [
                { url: `${API_BASE_URL}/api/auth/status`, title: 'è®¤è¯çŠ¶æ€API' },
                { url: `${API_BASE_URL}/api/invoices`, title: 'å‘ç¥¨åˆ—è¡¨API' },
                { url: `${API_BASE_URL}/api/settings`, title: 'è®¾ç½®API' }
            ];
            
            for (const route of apiRoutes) {
                await testConnection(route.url, route.title);
            }
            
            // CORS æµ‹è¯•
            await testCORS();
            
            updateStatus('âœ… å®Œæ•´æµ‹è¯•å®Œæˆ', 'complete');
        }
        
        async function testCORS() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/status`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': FRONTEND_URL,
                        'Access-Control-Request-Method': 'GET',
                        'Access-Control-Request-Headers': 'Content-Type,Authorization'
                    }
                });
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };
                
                addResult('CORS é¢„æ£€è¯·æ±‚', 
                    `çŠ¶æ€: ${response.status}\n` +
                    `å…è®¸æ¥æº: ${corsHeaders['Access-Control-Allow-Origin'] || 'æœªè®¾ç½®'}\n` +
                    `å…è®¸æ–¹æ³•: ${corsHeaders['Access-Control-Allow-Methods'] || 'æœªè®¾ç½®'}\n` +
                    `å…è®¸å¤´éƒ¨: ${corsHeaders['Access-Control-Allow-Headers'] || 'æœªè®¾ç½®'}`, 
                    response.ok ? 'success' : 'error');
                    
            } catch (error) {
                addResult('CORS æµ‹è¯•', `é”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            updateStatus('ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•è¿æ¥çŠ¶æ€', 'info');
        }
        
        // é¡µé¢åŠ è½½æ—¶è¿è¡ŒåŸºç¡€æµ‹è¯•
        window.addEventListener('load', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>
</html>