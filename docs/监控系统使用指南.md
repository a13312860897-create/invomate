# 监控系统使用指南

## 概述

本系统集成了全面的监控功能，包括性能监控、数据一致性检查和系统健康监控。本指南将帮助您了解如何使用这些监控功能。

## 监控功能概览

### 1. 性能监控
- 自动记录所有API请求的响应时间
- 监控错误率和请求量
- 提供详细的性能统计数据

### 2. 数据一致性监控
- 定期检查系统各模块间的数据一致性
- 自动检测数据不一致问题
- 支持告警和日志记录

### 3. 系统健康监控
- 实时监控系统状态
- 内存使用情况监控
- 服务可用性检查

## API端点

### 健康检查
```
GET /api/monitoring/health
```
返回系统健康状态，包括：
- 系统状态
- 运行时间
- 内存使用情况
- 系统版本信息

### 性能统计
```
GET /api/monitoring/performance
```
需要认证。返回性能统计数据，包括：
- 各端点的请求统计
- 响应时间分析
- 错误率统计

### 数据一致性状态
```
GET /api/monitoring/consistency/status
```
需要认证。返回数据一致性监控状态：
- 监控运行状态
- 检查间隔设置
- 最后检查时间
- 检查结果数量

### 启动数据一致性监控
```
POST /api/monitoring/consistency/start
```
需要认证。启动数据一致性监控：
```json
{
  "interval": 300000  // 检查间隔（毫秒），默认5分钟
}
```

### 停止数据一致性监控
```
POST /api/monitoring/consistency/stop
```
需要认证。停止数据一致性监控。

### 执行一致性检查
```
POST /api/monitoring/consistency/check
```
需要认证。立即执行一次数据一致性检查。

### 获取一致性检查结果
```
GET /api/monitoring/consistency/results
```
需要认证。获取历史一致性检查结果。

### 重置性能统计
```
POST /api/monitoring/performance/reset
```
需要认证。重置所有性能统计数据。

## 使用示例

### 1. 检查系统健康状态
```bash
curl http://localhost:3002/api/monitoring/health
```

### 2. 获取性能统计（需要认证）
```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:3002/api/monitoring/performance
```

### 3. 启动数据一致性监控
```bash
curl -X POST \
     -H "Authorization: Bearer YOUR_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"interval": 300000}' \
     http://localhost:3002/api/monitoring/consistency/start
```

### 4. 执行一致性检查
```bash
curl -X POST \
     -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:3002/api/monitoring/consistency/check
```

## 监控配置

### 环境变量
- `LOG_LEVEL`: 日志级别（ERROR, WARN, INFO, DEBUG）
- `MONITORING_ENABLED`: 是否启用监控（默认true）
- `CONSISTENCY_CHECK_INTERVAL`: 默认一致性检查间隔（毫秒）

### 性能监控配置
性能监控会自动记录以下指标：
- 请求响应时间
- 错误率
- 请求量
- 活跃请求数

### 数据一致性检查项目
系统会检查以下数据一致性：
1. 仪表板统计数据与实际数据的一致性
2. 发票总金额与明细项目金额的一致性
3. 客户关联的发票数量一致性
4. 报表数据与源数据的一致性

## 告警机制

### 性能告警
当以下情况发生时会触发告警：
- 平均响应时间超过阈值
- 错误率超过设定值
- 内存使用率过高

### 数据一致性告警
当数据一致性检查失败时会：
- 记录详细的错误日志
- 发送告警通知（如果配置）
- 更新监控状态

## 日志记录

所有监控活动都会记录到日志文件中：
- 位置：`logs/` 目录
- 格式：按日期命名的日志文件
- 内容：包括时间戳、日志级别和详细信息

## 故障排除

### 常见问题

1. **监控端点返回401错误**
   - 确保提供了有效的认证token
   - 检查token是否已过期

2. **数据一致性检查失败**
   - 检查数据库连接
   - 查看详细的错误日志
   - 确认数据模型定义正确

3. **性能统计数据为空**
   - 确保已有API请求产生
   - 检查性能监控中间件是否正确配置

### 调试步骤

1. 检查服务器日志
2. 验证数据库连接
3. 确认监控服务是否正常启动
4. 测试各个监控端点

## 最佳实践

1. **定期检查监控状态**
   - 建议每天检查系统健康状态
   - 定期查看性能统计数据

2. **合理设置检查间隔**
   - 根据系统负载调整一致性检查间隔
   - 避免过于频繁的检查影响性能

3. **监控日志管理**
   - 定期清理旧的日志文件
   - 设置日志轮转策略

4. **告警响应**
   - 建立告警响应流程
   - 及时处理一致性问题

## 扩展功能

系统支持以下扩展：
- 自定义监控指标
- 第三方告警集成
- 监控数据导出
- 自定义一致性检查规则

如需更多帮助，请查看系统日志或联系技术支持。