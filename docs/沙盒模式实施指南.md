# 法国电子发票沙盒模式实施指南

## 概述

本指南旨在为InvoMate SaaS平台实施法国电子发票的沙盒测试模式，确保在正式环境部署前100%验证合规性和功能性。

## 为什么必须实施沙盒模式

### 风险规避
- **法国风险**：PDP/PPF系统要求实时验证，XML格式错误或签名失效可能导致最高75万欧元罚款
- **2025年法规更新**：法国税务当局强制要求沙盒测试认证

### 法规要求
- **法国**：DGFiP要求PDP必须通过沙盒认证（2025年6月试点已验证）

### 信誉保护
- 避免早期bug导致SMB用户流失
- 防止负面评论在LinkedIn/Reddit等平台传播

## 实施计划（1-2周完成）

### 第一阶段：官方沙盒测试（开发团队）

#### 1. 法国DGFiP沙盒集成
**资源**：dgfipldev.gouv.fr 或 aife.economie.gouv.fr

**实施步骤**：
```bash
# 1. 注册开发者账号（免费）
curl -X POST https://dgfipldev.gouv.fr/api/register \
  -H "Content-Type: application/json" \
  -d '{"company":"InvoMate","email":"dev@invomate.com"}'

# 2. 获取测试API密钥
export FRENCH_TEST_API_KEY=$(curl -s https://dgfipldev.gouv.fr/api/keys | jq -r '.test_key')

# 3. 测试XML发票发送
curl -X POST https://dgfipldev.gouv.fr/api/invoices \
  -H "Authorization: Bearer $FRENCH_TEST_API_KEY" \
  -H "Content-Type: application/xml" \
  -d @test-invoice-fr.xml
```

**测试场景**：
- 标准B2B发票
- 多币种发票（EUR/USD）
- 无效签名测试
- 错误VAT号测试



### 第二阶段：内部用户沙盒（Beta测试）

#### 1. 模式切换实现

**前端实现（React）**：
```javascript
// src/components/SandboxToggle.jsx
import React from 'react';
import { useSandbox } from '../context/SandboxContext';

const SandboxToggle = () => {
  const { isSandbox, toggleSandbox } = useSandbox();
  
  return (
    <div className="sandbox-toggle">
      <label className="relative inline-flex items-center cursor-pointer">
        <input 
          type="checkbox" 
          checked={isSandbox}
          onChange={toggleSandbox}
          className="sr-only peer"
        />
        <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
        <span className="ml-3 text-sm font-medium text-gray-900">
          {isSandbox ? '沙盒模式已启用' : '生产模式'}
        </span>
      </label>
      {isSandbox && (
        <div className="mt-2 p-2 bg-yellow-100 text-yellow-800 rounded">
          ⚠️ 当前为测试环境，所有发票均为模拟
        </div>
      )}
    </div>
  );
};
```

**后端实现（Node.js）**：
```javascript
// src/middleware/sandboxMiddleware.js
const sandboxMiddleware = (req, res, next) => {
  const isSandbox = req.headers['x-sandbox-mode'] === 'true';
  
  if (isSandbox) {
    req.sandboxMode = true;
    // 使用模拟服务
    req.invoiceService = require('../services/mockInvoiceService');
  } else {
    req.sandboxMode = false;
    // 使用真实服务
    req.invoiceService = require('../services/realInvoiceService');
  }
  
  next();
};

module.exports = sandboxMiddleware;
```

#### 2. 模拟服务器设置

**Express.js模拟服务器**：
```javascript
// sandbox/mockServer.js
const express = require('express');
const app = express();

// 法国模拟响应
app.post('/api/fr/invoices', (req, res) => {
  res.json({
    status: 'success',
    invoiceId: `FR-TEST-${Date.now()}`,
    validationCode: 'VALID-FR-2025',
    timestamp: new Date().toISOString(),
    watermark: 'TEST INVOICE - NOT VALID FOR TAX PURPOSES'
  });
});



app.listen(3002, () => {
  console.log('沙盒模拟服务器运行在端口 3002');
});
```

#### 3. 测试数据生成

**法国测试数据生成器**：
```javascript
// sandbox/generateFrenchTestData.js
const generateFrenchInvoice = () => ({
  invoiceNumber: `FR-INV-${Date.now()}`,
  issueDate: new Date().toISOString().split('T')[0],
  seller: {
    name: 'Test Company France',
    siret: '12345678901234',
    vatNumber: 'FR12345678901'
  },
  buyer: {
    name: 'Test Client France',
    siret: '98765432109876',
    vatNumber: 'FR98765432109'
  },
  items: [
    {
      description: 'Test Service France',
      quantity: 1,
      unitPrice: 100.00,
      vatRate: 20.0
    }
  ],
  currency: 'EUR',
  totalAmount: 120.00,
  testMode: true
});
```


      ncm: '1234.56.78'
    }
  ],
  cbsTax: 9.0,
  ibsTax: 4.0,
  testMode: true
});
```

## 部署和测试流程

### 1. 开发环境配置
```bash
# 启动沙盒模式
cd g:\发票软件
npm run sandbox

# 启动模拟服务器
node sandbox/mockServer.js
```

### 2. 测试检查清单

#### 法国测试场景
- [ ] 标准发票创建
- [ ] 多币种支持（EUR/USD/GBP）
- [ ] 错误处理（无效VAT号）
- [ ] 签名验证失败
- [ ] 网络超时处理



### 3. 用户Beta测试

#### 邀请流程
1. 选择10-20个信任用户
2. 提供沙盒使用指南
3. 设置1周强制测试期
4. 收集反馈并修复问题

#### 反馈收集表单
```markdown
### 沙盒测试反馈表
**国家**：法国
**功能测试**：
- 发票创建是否成功？
- 错误提示是否清晰？
- 界面是否有误导？
**改进建议**：
- 需要增加什么测试场景？
- 哪些方面需要优化？
```

## 监控和日志

### 1. 错误监控
```javascript
// src/services/errorMonitoring.js
const Sentry = require('@sentry/node');

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  beforeSend(event) {
    if (event.user && event.user.isSandbox) {
      event.tags = { ...event.tags, sandbox: true };
    }
    return event;
  }
});
```

### 2. 测试报告生成
```javascript
// sandbox/generateReport.js
const generateTestReport = () => {
  const report = {
    timestamp: new Date().toISOString(),
    totalTests: 100,
    passed: 98,
    failed: 2,
    countries: {
      france: { passed: 50, failed: 1 }
    },
    recommendations: [
      '修复法国VAT号验证逻辑'
    ]
  };
  
  fs.writeFileSync('test-report.json', JSON.stringify(report, null, 2));
};
```

## 上线策略

### 1. 分阶段部署
- **第1周**：内部团队测试
- **第2周**：Beta用户沙盒测试
- **第3周**：修复关键问题
- **第4周**：生产环境切换

### 2. 回滚计划
```javascript
// 紧急回滚脚本
const emergencyRollback = () => {
  // 立即切换到生产模式
  process.env.FORCE_PRODUCTION = 'true';
  // 通知所有用户
  sendNotification('系统已切换到生产模式');
};
```

## 成本和时间估算

| 项目 | 成本 | 时间 |
|------|------|------|
| 官方沙盒测试 | 免费 | 3-5天 |
| 内部沙盒开发 | 免费（复用现有代码） | 2-3天 |
| Beta用户测试 | 免费 | 1周 |
| 专家审核 | $20/hr × 5小时 = $100 | 1天 |
| **总计** | **$100** | **1-2周** |

## 联系资源

- **法国专家**：Upwork搜索"French e-invoicing consultant"

- **技术支持**：contact@invomate.com

## 下一步行动

1. 立即注册法国DGFiP开发者账号
2. 开始实施内部沙盒模式
3. 联系本地专家进行代码审核

---

**文档版本**：v1.0  
**最后更新**：2025年1月  
**负责人**：InvoMate开发团队