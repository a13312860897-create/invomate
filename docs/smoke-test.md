# Paddle集成冒烟测试

## 测试目标
验证Paddle支付集成在沙盒环境下的完整流程，确保审核通过后可以快速切换到生产环境。

## 测试环境
- 前端: http://localhost:3001
- 后端: http://localhost:3002
- Paddle环境: 沙盒 (Sandbox)

## 测试准备
1. 确保后端服务已启动
2. 确保前端服务已启动
3. 确保环境变量配置正确:
   - 后端: PADDLE_ENVIRONMENT=sandbox
   - 前端: REACT_APP_PADDLE_ENV=sandbox

## 测试步骤

### 步骤1: 访问定价页面
- **操作**: 打开浏览器，访问 http://localhost:3001/paddle-pricing
- **预期结果**: 显示三大定价计划（入门版、专业版、企业版）
- **截图**: ✅ 定价页面完整显示

### 步骤2: 选择计划并点击升级
- **操作**: 
  1. 登录系统（如果没有登录）
  2. 选择"专业版"计划
  3. 点击"立即升级到专业版"按钮
- **预期结果**: 弹出Paddle沙盒结账页面
- **截图**: ✅ Paddle结账页面弹出

### 步骤3: 使用测试卡完成支付
- **操作**:
  1. 在Paddle结账页面填写测试邮箱
  2. 输入测试卡信息: 4242 4242 4242 4242
  3. 输入任意未来日期和CVC
  4. 点击"支付"按钮
- **预期结果**: 支付成功，跳转至成功页面
- **截图**: ✅ 支付成功页面

### 步骤4: 验证后端webhook接收
- **操作**: 查看后端控制台日志
- **预期结果**: 控制台打印 `transaction.completed` 事件，状态为completed
- **截图**: ✅ 后端控制台显示交易完成事件

### 步骤5: 测试退款功能
- **操作**:
  1. 获取交易ID（从webhook日志或数据库中查找）
  2. 使用API工具（如Postman）发送退款请求:
     ```
     POST http://localhost:3002/api/paddle/refund
     Content-Type: application/json
     
     {
       "transactionId": "交易ID",
       "amount": "50%"
     }
     ```
- **预期结果**: 退款请求成功，状态为approved
- **截图**: ✅ 退款成功响应

### 步骤6: 验证用户订阅状态
- **操作**: 检查数据库中用户订阅状态
- **预期结果**: 用户订阅状态已更新为专业版（pro）
- **截图**: ✅ 数据库中用户tier字段更新为pro

## 测试结果
| 步骤 | 预期结果 | 实际结果 | 状态 |
|------|----------|----------|------|
| 1 | 显示三大计划 | 显示三大计划 | ✅ |
| 2 | 弹出Paddle结账页 | 弹出Paddle结账页 | ✅ |
| 3 | 跳转成功页面 | 跳转成功页面 | ✅ |
| 4 | 后端接收webhook | 后端接收webhook | ✅ |
| 5 | 退款成功 | 退款成功 | ✅ |
| 6 | 用户状态更新 | 用户状态更新 | ✅ |

## 审核通过后上线步骤
1. 修改环境变量:
   ```
   PADDLE_ENVIRONMENT=production
   PADDLE_API_KEY=live_xxx
   ```
2. 重新构建前端: `npm run build`
3. 更新webhook地址为生产域名
4. 使用真实银行卡进行小额测试（1美元）并退款（0.5美元）
5. 正式上线

## 注意事项
- 所有测试均在沙盒环境进行，不涉及真实金钱
- 测试卡信息: 4242 4242 4242 4242
- 测试邮箱可使用任意有效邮箱格式
- 审核通过后只需修改环境变量即可切换到生产环境