# 测试指南

## 概述

本指南介绍如何运行和使用系统的各种测试，包括数据一致性测试、性能测试和集成测试。

## 测试类型

### 1. 数据一致性测试
验证系统各模块间数据的一致性，确保数据完整性和准确性。

### 2. 性能测试
测试API响应时间、并发处理能力和系统资源使用情况。

### 3. 集成测试
测试各个模块之间的集成和第三方服务的集成。

## 测试环境设置

### 前置条件
1. Node.js 环境（推荐 v14 或更高版本）
2. 已安装项目依赖：`npm install`
3. 数据库连接正常
4. 服务器正在运行

### 环境变量
```bash
# 测试环境配置
NODE_ENV=test
DB_TYPE=memory  # 使用内存数据库进行测试
LOG_LEVEL=INFO
CREATE_TEST_DATA=true
```

## 运行测试

### 数据一致性测试

#### 仪表板一致性测试
```bash
cd tests/consistency
node dashboard-consistency-test.js
```

测试内容：
- 仪表板统计数据与实际数据的一致性
- 总发票数量、总收入、客户数量等指标

#### 客户一致性测试
```bash
cd tests/consistency
node client-consistency-test.js
```

测试内容：
- 客户数据的完整性
- 客户关联发票的一致性
- 客户统计信息的准确性

#### 报表一致性测试
```bash
cd tests/consistency
node report-consistency-test.js
```

测试内容：
- 报表数据与源数据的一致性
- 财务报表的计算准确性
- 时间范围过滤的正确性

#### 发票一致性测试
```bash
cd tests/consistency
node invoice-consistency-test.js
```

测试内容：
- 发票总金额与明细项目的一致性
- 发票状态的正确性
- 税费计算的准确性

### 运行所有一致性测试
```bash
cd tests
node run-all-consistency-tests.js
```

### 性能测试

#### API性能测试
```bash
cd tests/performance
node api-performance-test.js
```

测试内容：
- 各API端点的响应时间
- 并发请求处理能力
- 内存使用情况

#### 数据库性能测试
```bash
cd tests/performance
node database-performance-test.js
```

测试内容：
- 数据库查询性能
- 大数据量处理能力
- 索引效果验证

## 测试配置

### 测试用户凭据
```javascript
const TEST_AUTH = {
  email: 'a133128860897@163.com',
  password: 'Ddtb959322'
};
```

### API基础URL
```javascript
const BASE_URL = 'http://localhost:3002/api';
```

### 测试数据配置
```javascript
const TEST_CONFIG = {
  maxRetries: 3,
  timeout: 5000,
  consistencyThreshold: 0.95
};
```

## 测试结果解读

### 一致性测试结果
```json
{
  "success": true,
  "testName": "仪表板一致性测试",
  "results": {
    "totalInvoices": {
      "expected": 10,
      "actual": 10,
      "consistent": true
    },
    "totalRevenue": {
      "expected": 15000.00,
      "actual": 15000.00,
      "consistent": true
    }
  },
  "overallConsistency": 1.0,
  "timestamp": "2024-01-01T10:00:00.000Z"
}
```

### 性能测试结果
```json
{
  "endpoint": "/api/dashboard/dashboard-stats",
  "method": "GET",
  "averageResponseTime": 45,
  "minResponseTime": 32,
  "maxResponseTime": 78,
  "requestCount": 100,
  "errorCount": 0,
  "errorRate": 0,
  "throughput": 22.2
}
```

## 自动化测试

### 设置定时测试
创建定时任务来自动运行测试：

```bash
# 每小时运行一致性测试
0 * * * * cd /path/to/project/tests && node run-all-consistency-tests.js

# 每天运行性能测试
0 2 * * * cd /path/to/project/tests/performance && node api-performance-test.js
```

### CI/CD 集成
在CI/CD流水线中集成测试：

```yaml
# .github/workflows/test.yml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'
      - name: Install dependencies
        run: npm install
      - name: Run consistency tests
        run: cd tests && node run-all-consistency-tests.js
      - name: Run performance tests
        run: cd tests/performance && node api-performance-test.js
```

## 测试最佳实践

### 1. 测试隔离
- 每个测试使用独立的测试数据
- 测试之间不应相互依赖
- 使用内存数据库避免数据污染

### 2. 测试数据管理
- 使用固定的测试数据集
- 测试前清理数据
- 测试后恢复初始状态

### 3. 错误处理
- 测试各种错误场景
- 验证错误响应格式
- 检查错误日志记录

### 4. 性能基准
- 建立性能基准线
- 监控性能回归
- 设置合理的性能阈值

## 故障排除

### 常见问题

1. **测试认证失败**
   ```
   解决方案：
   - 检查测试用户凭据
   - 确认服务器正在运行
   - 验证认证端点可用
   ```

2. **数据一致性测试失败**
   ```
   解决方案：
   - 检查数据库连接
   - 验证测试数据完整性
   - 查看详细错误日志
   ```

3. **性能测试超时**
   ```
   解决方案：
   - 增加测试超时时间
   - 检查服务器负载
   - 优化数据库查询
   ```

### 调试技巧

1. **启用详细日志**
   ```bash
   LOG_LEVEL=DEBUG node test-file.js
   ```

2. **单独运行测试**
   ```bash
   # 只运行特定测试
   node dashboard-consistency-test.js --verbose
   ```

3. **检查测试数据**
   ```bash
   # 查看测试数据状态
   curl http://localhost:3002/api/dashboard/dashboard-stats
   ```

## 测试报告

### 生成测试报告
```bash
# 生成HTML测试报告
node generate-test-report.js --format html --output reports/

# 生成JSON测试报告
node generate-test-report.js --format json --output reports/test-results.json
```

### 报告内容
- 测试执行摘要
- 详细测试结果
- 性能指标分析
- 错误和警告信息
- 趋势分析图表

## 扩展测试

### 添加新的一致性测试
1. 在 `tests/consistency/` 目录创建新测试文件
2. 继承基础测试类
3. 实现具体的检查逻辑
4. 更新测试套件

### 自定义性能测试
1. 在 `tests/performance/` 目录创建测试文件
2. 定义测试场景和负载
3. 实现性能指标收集
4. 设置性能阈值

## 联系支持

如果遇到测试相关问题：
1. 查看系统日志文件
2. 检查测试文档和示例
3. 联系开发团队获取支持

---

更多详细信息请参考各个测试文件中的注释和文档。