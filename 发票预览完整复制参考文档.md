# 发票预览完整复制参考文档

> **文档目的**: 为完全复制发票预览的全部内容和格式提供详细的技术参考，确保复制时的准确性和完整性。

## 文档版本信息
- **创建日期**: 2025-01-26
- **版本**: v1.0
- **维护者**: AI助手
- **适用范围**: 发票预览功能的完整复制

---

## 1. 发票预览核心组件架构

### 1.1 主要组件文件
- **主组件**: `frontend/src/components/Invoice/InvoicePreview.js` (638行)
- **备用组件**: `frontend/src/components/InvoicePreview.jsx` (600行)
- **打印预览**: `frontend/src/components/PrintPreview.jsx` (632行)
- **新打印预览**: `frontend/src/components/PrintPreviewNew.jsx` (650行)

### 1.2 组件层次结构
```
InvoicePreview (主容器)
├── 预览标题区域
├── 发票头部信息
│   ├── 发票编号显示
│   ├── 发票类型 (法国合规)
│   └── 模板信息显示
├── 日期信息区域
│   ├── 发票日期
│   ├── 到期日期
│   └── 交付日期
├── 发票方信息 (卖家)
│   ├── 公司基本信息
│   ├── 法国法律字段
│   └── TVA状态显示
├── 收票方信息 (客户)
│   ├── 账单地址
│   └── 交付地址 (可选)
├── 法国特定字段
│   ├── 订单引用
│   └── 合同引用
├── 发票项目表格
│   ├── 表头
│   ├── 项目行
│   └── 总计区域
├── 备注区域
└── 法国法律条款
```

---

## 2. 完整数据结构定义

### 2.1 发票基本数据 (formData)
```javascript
{
  // 基本信息
  invoiceNumber: String,           // 发票编号
  issueDate: String,              // 开票日期 (YYYY-MM-DD)
  dueDate: String,                // 到期日期 (YYYY-MM-DD)
  deliveryDate: String,           // 交付日期 (YYYY-MM-DD)
  currency: String,               // 币种 (默认: EUR)
  
  // 客户信息
  clientId: Number,               // 客户ID
  
  // 发票项目
  items: [
    {
      description: String,        // 项目描述
      quantity: Number,           // 数量
      unitPrice: Number,          // 单价
      taxRate: Number,            // 税率 (%)
      total: Number               // 小计 (自动计算)
    }
  ],
  
  // 卖方信息 (从用户设置或SettingsContext获取)
  sellerCompanyName: String,      // 公司名称
  sellerEmail: String,            // 邮箱
  sellerPhone: String,            // 电话
  sellerAddress: String,          // 地址
  sellerCity: String,             // 城市
  sellerPostalCode: String,       // 邮政编码
  sellerCountry: String,          // 国家
  
  // 法国法律字段
  sellerVATNumber: String,        // TVA号码
  sellerSiren: String,            // SIREN号码
  sellerSiret: String,            // SIRET号码
  sellerLegalForm: String,        // 法律形式
  sellerCapital: String,          // 注册资本
  sellerRcsNumber: String,        // RCS号码
  sellerNafCode: String,          // NAF代码
  
  // 法国特定字段
  orderReference: String,         // 订单参考
  contractReference: String,      // 合同参考
  invoiceType: String,            // 发票类型
  tvaExempt: Boolean,             // TVA豁免
  autoLiquidation: Boolean,       // 自清算
  
  // 其他
  notes: String,                  // 备注
  defaultTaxRate: Number          // 默认税率
}
```

### 2.2 客户数据结构 (Client)
```javascript
{
  id: Number,                     // 客户ID
  name: String,                   // 联系人姓名
  email: String,                  // 邮箱
  company: String,                // 公司名称
  phone: String,                  // 电话
  
  // 账单地址
  address: String,                // 地址
  city: String,                   // 城市
  postalCode: String,             // 邮政编码
  country: String,                // 国家
  
  // 交付地址 (可选)
  deliveryAddress: String,        // 交付地址
  deliveryCity: String,           // 交付城市
  deliveryPostalCode: String,     // 交付邮政编码
  deliveryCountry: String,        // 交付国家
  
  // 法国法律字段
  vatNumber: String,              // TVA号码
  siren: String,                  // SIREN号码
  siret: String,                  // SIRET号码
  
  // 兼容性字段映射
  companyName: String,            // = company
  contactName: String,            // = name
  sirenNumber: String,            // = siren
  siretNumber: String             // = siret
}
```

### 2.3 用户设置数据 (User/SettingsContext)
```javascript
{
  // 基本信息
  firstName: String,              // 名
  lastName: String,               // 姓
  email: String,                  // 邮箱
  phone: String,                  // 电话
  
  // 公司信息
  companyName: String,            // 公司名称
  logo: String,                   // 公司Logo路径
  
  // 地址信息
  address: String,                // 地址
  city: String,                   // 城市
  postalCode: String,             // 邮政编码
  country: String,                // 国家
  
  // 法国法律字段
  vatNumber: String,              // TVA号码
  siren: String,                  // SIREN号码
  siretNumber: String,            // SIRET号码
  legalForm: String,              // 法律形式
  capital: String,                // 注册资本
  rcsNumber: String,              // RCS号码
  nafCode: String,                // NAF代码
  
  // 银行信息
  bankName: String,               // 银行名称
  bankAccount: String,            // 银行账户
  iban: String,                   // IBAN
  bic: String                     // BIC/SWIFT
}
```

---

## 3. API接口完整映射

### 3.1 发票相关API
```javascript
// 基础路径: /api/invoices

// 获取发票列表
GET /api/invoices
Query参数: {
  page: Number,           // 页码
  limit: Number,          // 每页数量
  status: String,         // 状态筛选
  clientId: Number,       // 客户筛选
  dateFrom: String,       // 开始日期
  dateTo: String,         // 结束日期
  search: String,         // 搜索关键词
  sortBy: String,         // 排序字段
  sortOrder: String       // 排序方向
}

// 获取单个发票
GET /api/invoices/:id
返回: {
  success: Boolean,
  data: {
    invoice: {
      ...发票基本信息,
      Client: {...客户信息},
      InvoiceItems: [...发票项目]
    }
  }
}

// 创建发票
POST /api/invoices
请求体: {...发票数据}

// 更新发票
PUT /api/invoices/:id
请求体: {...更新数据}

// 删除发票
DELETE /api/invoices/:id

// 生成PDF
GET /api/invoices/:id/pdf
返回: PDF文件流

// 发送邮件
POST /api/invoices/:id/send
请求体: {
  customMessage: String,
  ccEmails: Array,
  bccEmails: Array,
  forceRegeneratePDF: Boolean,
  customSubject: String,
  emailMethod: String
}
```

### 3.2 客户相关API
```javascript
// 基础路径: /api/clients

// 获取客户列表
GET /api/clients
返回: {
  success: Boolean,
  data: {
    clients: [...客户列表]
  }
}

// 获取单个客户
GET /api/clients/:id

// 创建客户
POST /api/clients

// 更新客户
PUT /api/clients/:id

// 删除客户
DELETE /api/clients/:id
```

### 3.3 用户设置API
```javascript
// 基础路径: /api/users

// 获取用户信息
GET /api/users/profile
返回: {
  success: Boolean,
  data: {...用户信息}
}

// 更新用户信息
PUT /api/users/profile
请求体: {...更新数据}

// 上传Logo
POST /api/users/upload-logo
Content-Type: multipart/form-data
```

### 3.4 模板相关API
```javascript
// 基础路径: /api/invoice-templates

// 获取模板列表
GET /api/invoice-templates

// 获取单个模板
GET /api/invoice-templates/:id

// 创建模板
POST /api/invoice-templates

// 更新模板
PUT /api/invoice-templates/:id
```

---

## 4. 样式和格式化规则

### 4.1 主要CSS类和样式
```css
/* 主容器样式 */
.bg-white.rounded-lg.shadow-sm.border.border-gray-200 {
  background: white;
  border-radius: 0.5rem;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  border: 1px solid #e5e7eb;
}

/* 预览标题区域 */
.bg-gray-50.px-4.py-3.border-b.border-gray-200 {
  background: #f9fafb;
  padding: 0.75rem 1rem;
  border-bottom: 1px solid #e5e7eb;
}

/* 发票头部 */
.text-2xl.sm:text-3xl.font-bold.text-gray-900 {
  font-size: 1.875rem; /* 30px */
  font-weight: 700;
  color: #111827;
}

/* 网格布局 */
.grid.grid-cols-1.md:grid-cols-2.gap-8 {
  display: grid;
  grid-template-columns: repeat(1, minmax(0, 1fr));
  gap: 2rem;
}

@media (min-width: 768px) {
  .grid.grid-cols-1.md:grid-cols-2.gap-8 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

/* 表格样式 */
.min-w-full.divide-y.divide-gray-200 {
  min-width: 100%;
  border-collapse: separate;
  border-spacing: 0;
}

.bg-gray-50 {
  background-color: #f9fafb;
}

/* 文本样式 */
.text-sm.font-medium.text-gray-900 {
  font-size: 0.875rem;
  font-weight: 500;
  color: #111827;
}

.text-xs.font-medium.text-gray-500.uppercase.tracking-wider {
  font-size: 0.75rem;
  font-weight: 500;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
```

### 4.2 打印样式 (print.css)
```css
@media print {
  /* 隐藏所有不需要打印的元素 */
  body * {
    visibility: hidden !important;
  }
  
  /* 只显示发票预览内容 */
  .invoice-print-container,
  .invoice-print-container * {
    visibility: visible !important;
  }
  
  /* 页面设置 */
  @page {
    margin: 20mm;
    size: A4;
  }
  
  /* 表格打印优化 */
  .invoice-print-container table {
    page-break-inside: auto !important;
  }
  
  .invoice-print-container tr {
    page-break-inside: avoid !important;
    page-break-after: auto !important;
  }
  
  /* 避免在关键元素处分页 */
  .invoice-print-container .invoice-header {
    page-break-after: avoid !important;
  }
  
  .invoice-print-container .invoice-totals {
    page-break-before: avoid !important;
  }
}
```

### 4.3 响应式设计规则
```css
/* 移动端适配 */
@media (max-width: 640px) {
  .text-2xl.sm:text-3xl {
    font-size: 1.5rem; /* 24px */
  }
  
  .p-4.sm:p-6.lg:p-8 {
    padding: 1rem;
  }
  
  .grid.grid-cols-1.md:grid-cols-2 {
    grid-template-columns: 1fr;
  }
}

/* 平板端适配 */
@media (min-width: 641px) and (max-width: 1024px) {
  .p-4.sm:p-6.lg:p-8 {
    padding: 1.5rem;
  }
}

/* 桌面端适配 */
@media (min-width: 1025px) {
  .p-4.sm:p-6.lg:p-8 {
    padding: 2rem;
  }
}
```

---

## 5. 数据计算逻辑

### 5.1 金额计算 (useMemo优化)
```javascript
const calculations = useMemo(() => {
  // 小计计算
  const subtotal = formData.items.reduce((total, item) => 
    total + ((item.quantity || 0) * (item.unitPrice || 0)), 0
  );
  
  // 税额计算
  let totalTax = 0;
  if (!formData.tvaExempt && !formData.autoLiquidation) {
    totalTax = formData.items.reduce((total, item) => {
      const itemSubtotal = (item.quantity || 0) * (item.unitPrice || 0);
      const taxRate = typeof item.taxRate === 'object' ? 0 : (item.taxRate || 0);
      return total + (itemSubtotal * (taxRate / 100));
    }, 0);
  }
  
  // 总计计算
  const grandTotal = subtotal + totalTax;
  
  return { subtotal, totalTax, grandTotal };
}, [formData.items, formData.tvaExempt, formData.autoLiquidation]);
```

### 5.2 货币格式化
```javascript
const formatCurrency = (amount) => {
  return new Intl.NumberFormat('fr-FR', {
    style: 'currency',
    currency: 'EUR',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(amount || 0);
};
```

### 5.3 日期格式化
```javascript
const formatDate = (dateString) => {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toLocaleDateString('fr-FR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};
```

---

## 6. 多语言支持

### 6.1 法国模板标签映射
```javascript
const getFrenchLabel = (key, fallback = '') => {
  const frenchLabels = {
    'preview': 'Aperçu',
    'invoice': 'FACTURE',
    'from': 'De',
    'to': 'À',
    'invoicedate': 'Date de facture',
    'duedate': 'Date d\'échéance',
    'deliverydate': 'Date de livraison',
    'items': 'Articles',
    'description': 'Description',
    'qty': 'Qté',
    'price': 'Prix unitaire',
    'taxpercent': 'TVA',
    'total': 'Total',
    'subtotal': 'Sous-total',
    'tax': 'TVA',
    'grandtotal': 'Total TTC',
    'notes': 'Notes',
    'companylogo': 'Logo de l\'entreprise',
    'frenchCompliance': 'Conformité française',
    'complianceAdded': 'Ajouté pour la conformité'
  };
  
  return frenchLabels[key] || fallback || key;
};
```

### 6.2 发票类型标签
```javascript
const invoiceTypeLabels = {
  'standard': 'Facture standard',
  'credit': 'Avoir',
  'proforma': 'Facture pro forma',
  'deposit': 'Facture d\'acompte',
  'final': 'Facture de solde'
};
```

---

## 7. 法国法律合规要求

### 7.1 必需的法律字段
```javascript
// 卖方必需字段
const requiredSellerFields = [
  'companyName',        // 公司名称
  'address',           // 地址
  'vatNumber',         // TVA号码
  'siren',             // SIREN号码
  'siret',             // SIRET号码
  'legalForm',         // 法律形式
  'capital',           // 注册资本
  'rcsNumber',         // RCS号码
  'nafCode'            // NAF代码
];

// 发票必需字段
const requiredInvoiceFields = [
  'invoiceNumber',     // 发票编号
  'issueDate',         // 开票日期
  'dueDate',           // 到期日期
  'invoiceType'        // 发票类型
];
```

### 7.2 法律条款模板
```javascript
const legalTermsTemplate = {
  hiddenDefects: "Aucune garantie n'est accordée pour les vices cachés.",
  paymentTerms: "Paiement à réception de facture. Toute somme non payée à l'échéance portera de plein droit intérêt au taux de 3 fois le taux légal en vigueur, ainsi qu'une indemnité forfaitaire pour frais de recouvrement de 40 euros.",
  ownershipReservation: "Nous nous réservons la propriété des marchandises jusqu'au paiement intégral de la facture.",
  disputeResolution: "Tout litige relève de la compétence du tribunal de commerce de [Ville].",
  tvaInfo: "TVA non applicable, art. 293 B du CGI" // Si applicable
};
```

---

## 8. 组件Props接口定义

### 8.1 InvoicePreview组件Props
```javascript
InvoicePreview.propTypes = {
  formData: PropTypes.shape({
    invoiceNumber: PropTypes.string,
    issueDate: PropTypes.string,
    dueDate: PropTypes.string,
    deliveryDate: PropTypes.string,
    clientId: PropTypes.number,
    items: PropTypes.arrayOf(PropTypes.shape({
      description: PropTypes.string,
      quantity: PropTypes.number,
      unitPrice: PropTypes.number,
      taxRate: PropTypes.number
    })),
    notes: PropTypes.string,
    orderReference: PropTypes.string,
    contractReference: PropTypes.string,
    invoiceType: PropTypes.string,
    tvaExempt: PropTypes.bool,
    autoLiquidation: PropTypes.bool
  }).isRequired,
  
  clients: PropTypes.arrayOf(PropTypes.shape({
    id: PropTypes.number,
    name: PropTypes.string,
    email: PropTypes.string,
    company: PropTypes.string,
    address: PropTypes.string,
    city: PropTypes.string,
    postalCode: PropTypes.string,
    country: PropTypes.string,
    vatNumber: PropTypes.string,
    siren: PropTypes.string,
    siret: PropTypes.string
  })),
  
  user: PropTypes.shape({
    companyName: PropTypes.string,
    firstName: PropTypes.string,
    lastName: PropTypes.string,
    email: PropTypes.string,
    phone: PropTypes.string,
    address: PropTypes.string,
    city: PropTypes.string,
    postalCode: PropTypes.string,
    country: PropTypes.string,
    vatNumber: PropTypes.string,
    siren: PropTypes.string,
    siretNumber: PropTypes.string,
    legalForm: PropTypes.string,
    capital: PropTypes.string,
    rcsNumber: PropTypes.string,
    nafCode: PropTypes.string,
    logo: PropTypes.string
  }),
  
  selectedTemplate: PropTypes.string,
  invoiceMode: PropTypes.string,
  t: PropTypes.func // 翻译函数
};
```

---

## 9. 状态管理和Context

### 9.1 SettingsContext结构
```javascript
const SettingsContext = createContext({
  settings: {
    // 公司基本信息
    companyName: '',
    logo: '',
    email: '',
    phone: '',
    address: '',
    city: '',
    postalCode: '',
    country: '',
    
    // 法国法律字段
    vatNumber: '',
    siren: '',
    siretNumber: '',
    legalForm: '',
    capital: '',
    rcsNumber: '',
    nafCode: '',
    
    // 银行信息
    bankName: '',
    bankAccount: '',
    iban: '',
    bic: '',
    
    // 默认设置
    defaultTaxRate: 20,
    currency: 'EUR',
    invoiceNumberFormat: 'standard'
  },
  updateSettings: () => {},
  loading: false,
  error: null
});
```

### 9.2 状态更新逻辑
```javascript
// 设置优先级：SettingsContext > user对象 > 默认值
const getSellerInfo = () => {
  const { settings } = useContext(SettingsContext);
  
  return {
    companyName: settings?.companyName || user?.companyName || '',
    email: settings?.email || user?.email || '',
    phone: settings?.phone || user?.phone || '',
    address: settings?.address || user?.address || '',
    city: settings?.city || user?.city || '',
    postalCode: settings?.postalCode || user?.postalCode || '',
    country: settings?.country || user?.country || '',
    vatNumber: settings?.vatNumber || user?.vatNumber || '',
    siren: settings?.siren || user?.siren || '',
    siretNumber: settings?.siretNumber || user?.siretNumber || '',
    legalForm: settings?.legalForm || user?.legalForm || '',
    capital: settings?.capital || user?.capital || '',
    rcsNumber: settings?.rcsNumber || user?.rcsNumber || '',
    nafCode: settings?.nafCode || user?.nafCode || ''
  };
};
```

---

## 10. 错误处理和边界情况

### 10.1 数据验证规则
```javascript
const validateInvoiceData = (formData) => {
  const errors = [];
  
  // 必需字段验证
  if (!formData.clientId) {
    errors.push('客户信息不能为空');
  }
  
  if (!formData.issueDate) {
    errors.push('开票日期不能为空');
  }
  
  if (!formData.dueDate) {
    errors.push('到期日期不能为空');
  }
  
  if (!formData.items || formData.items.length === 0) {
    errors.push('发票项目不能为空');
  }
  
  // 项目验证
  formData.items?.forEach((item, index) => {
    if (!item.description) {
      errors.push(`第${index + 1}项描述不能为空`);
    }
    
    if (!item.quantity || item.quantity <= 0) {
      errors.push(`第${index + 1}项数量必须大于0`);
    }
    
    if (!item.unitPrice || item.unitPrice < 0) {
      errors.push(`第${index + 1}项单价不能为负数`);
    }
  });
  
  return errors;
};
```

### 10.2 默认值处理
```javascript
const getDefaultValues = () => ({
  invoiceNumber: '',
  issueDate: new Date().toISOString().split('T')[0],
  dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
  deliveryDate: '',
  clientId: null,
  items: [{
    description: '',
    quantity: 1,
    unitPrice: 0,
    taxRate: 20
  }],
  notes: '',
  orderReference: '',
  contractReference: '',
  invoiceType: 'standard',
  tvaExempt: false,
  autoLiquidation: false,
  currency: 'EUR',
  defaultTaxRate: 20
});
```

---

## 11. 性能优化建议

### 11.1 React优化
```javascript
// 使用useMemo缓存计算结果
const calculations = useMemo(() => {
  // 计算逻辑
}, [formData.items, formData.tvaExempt, formData.autoLiquidation]);

// 使用useCallback缓存事件处理函数
const handleItemChange = useCallback((index, field, value) => {
  // 处理逻辑
}, []);

// 使用React.memo包装组件
const InvoicePreview = React.memo(({ formData, clients, user, ...props }) => {
  // 组件逻辑
});
```

### 11.2 渲染优化
```javascript
// 条件渲染优化
const shouldShowFrenchFields = useMemo(() => {
  return selectedTemplate && 
    (selectedTemplate.startsWith('french-') || selectedTemplate === 'france-template');
}, [selectedTemplate]);

// 列表渲染优化
const renderInvoiceItems = useMemo(() => {
  return formData.items.map((item, index) => (
    <InvoiceItemRow 
      key={`item-${index}`}
      item={item}
      index={index}
      onChange={handleItemChange}
    />
  ));
}, [formData.items, handleItemChange]);
```

---

## 12. 测试要点

### 12.1 单元测试覆盖
- [ ] 金额计算逻辑测试
- [ ] 日期格式化测试
- [ ] 货币格式化测试
- [ ] 数据验证测试
- [ ] 默认值处理测试

### 12.2 集成测试覆盖
- [ ] API接口调用测试
- [ ] 组件渲染测试
- [ ] 用户交互测试
- [ ] 打印功能测试
- [ ] PDF生成测试

### 12.3 端到端测试覆盖
- [ ] 完整发票创建流程
- [ ] 发票预览显示
- [ ] 打印预览功能
- [ ] PDF下载功能
- [ ] 邮件发送功能

---

## 13. 复制检查清单

### 13.1 UI组件检查
- [ ] 预览标题区域完整复制
- [ ] 发票头部信息正确显示
- [ ] 日期信息区域布局一致
- [ ] 发票方信息完整显示
- [ ] 收票方信息正确映射
- [ ] 法国特定字段显示
- [ ] 发票项目表格格式
- [ ] 总计区域计算正确
- [ ] 备注区域显示
- [ ] 法国法律条款完整

### 13.2 数据流检查
- [ ] formData数据结构完整
- [ ] 客户数据正确获取
- [ ] 用户设置正确应用
- [ ] API接口调用正常
- [ ] 计算逻辑准确无误
- [ ] 格式化函数正常工作

### 13.3 样式检查
- [ ] CSS类名正确应用
- [ ] 响应式布局正常
- [ ] 打印样式正确
- [ ] 颜色和字体一致
- [ ] 间距和对齐正确
- [ ] 边框和阴影效果

### 13.4 功能检查
- [ ] 多语言支持正常
- [ ] 法国合规要求满足
- [ ] 错误处理完善
- [ ] 性能优化到位
- [ ] 边界情况处理
- [ ] 默认值正确设置

---

## 14. 常见问题和解决方案

### 14.1 数据不显示问题
**问题**: 客户信息或用户信息不显示
**解决**: 检查数据获取逻辑和字段映射

```javascript
// 确保客户数据正确获取
const selectedClient = clients.find(client => 
  client.id === formData.clientId || 
  String(client.id) === String(formData.clientId)
);

// 确保字段映射正确
if (client) {
  client.companyName = client.company;
  client.contactName = client.name;
}
```

### 14.2 计算错误问题
**问题**: 金额计算不正确
**解决**: 检查计算逻辑和数据类型

```javascript
// 确保数值类型正确
const quantity = Number(item.quantity) || 0;
const unitPrice = Number(item.unitPrice) || 0;
const taxRate = Number(item.taxRate) || 0;
```

### 14.3 样式显示问题
**问题**: 样式不正确或布局错乱
**解决**: 检查CSS类名和响应式设计

```javascript
// 确保CSS类名正确
className="bg-white border border-gray-200 rounded-lg shadow-sm"

// 检查响应式类名
className="grid grid-cols-1 md:grid-cols-2 gap-8"
```

---

## 15. 版本兼容性说明

### 15.1 组件版本差异
- **InvoicePreview.js**: 主要版本，功能最完整
- **InvoicePreview.jsx**: 简化版本，基础功能
- **PrintPreview.jsx**: 打印专用版本
- **PrintPreviewNew.jsx**: 新版打印预览

### 15.2 API版本兼容
- 内存模式和数据库模式的API差异
- 字段名称的兼容性处理
- 数据结构的版本差异

---

**文档结束**

> 此文档包含了发票预览功能的完整技术规格，可作为复制实现的详细参考。建议在复制过程中逐项对照检查，确保功能的完整性和准确性。